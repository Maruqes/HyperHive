syntax = "proto3";

package virsh;

option go_package = "github.com/Maruqes/512SvMan/api/proto/virsh;proto";

// get cpu features
message Empty {}

message GetCpuFeaturesResponse { repeated string features = 1; }

message CreateVmRequest {
  string name = 1;
  int32 memory = 2;
  int32 vcpu = 3;
  string disk_folder = 4;
  string disk_path = 5;
  int32 disk_sizeGB = 6;
  string iso_path = 7;
  string network = 8;
  string vnc_password = 9;
  string cpuXml = 10;
  bool is_windows = 11;
}

message OkResponse {
  bool ok = 1;
  string message = 2;
}

enum VmState {
  UNKNOWN = 0;
  RUNNING = 1;
  BLOCKED = 2;
  PAUSED = 3;
  SHUTDOWN = 4;
  SHUTOFF = 5;
  CRASHED = 6;
  PMSUSPENDED = 7;
  NOSTATE = 8;
}

message Vm {
  string machineName = 1;
  string name = 2;
  VmState state = 3;
  string novncPort = 4;
  int32 cpuCount = 5; // current cpu count
  int32 memoryMB = 6; // current mb
  int32 currentCpuUsage = 7; // current %
  int32 currentMemoryUsageMB = 8;
  int32 diskSizeGB = 9;
  string diskPath = 10;
  string spritePort = 11;
  repeated string ip = 12;
  string network = 13;
  string VNCPassword = 14;
  string CPUXML = 15;
  int32 DefinedCPUS = 16; // vm as for emxaple 5 cpus
  int32 DefinedRam = 17; // vm has 16G of memory (its in megas)
  int32 AllocatedGb = 18;
  int32 RealHostMemUsage = 19;
  string VideoModelType = 20; // video model type (e.g., "qxl", "virtio", "vga", "none")
}

message GetVmByNameRequest { string name = 1; }

message GetAllVmsResponse {
  repeated Vm vms = 1;
  repeated string warnings = 2;
}

message MigrateVmRequest {
  string name = 2;
  string slaveIp = 3;
  bool live = 4;
  int32 timeoutSeconds = 5;
}

message CPUXMLResponse { string cpuXML = 1; }

message UpdateVMCPUXmlRequest {
  string name = 1;
  string cpuXML = 2;
}

message ColdMigrationRequest {
  string vm_name = 1;
  int32 memory = 2;
  int32 v_cpus = 3;
  string network = 4;
  string vnc_password = 5;
  string cpuXML = 6;
  string disk_path = 7;
  bool live = 8;
}

message ChangeNetworkReq {
  string vmName = 1;
  string new_network = 2;
}

message ChangeVncPassword {
  string vmName = 1;
  string new_password = 2;
}

message GetNoVNCVideoResponse {
  bool enabled = 1;
  int32 video_count = 2;
  string model_type = 3;
  string video_xml = 4;
}

message SetMemoryBallooningRequest {
  string vm_name = 1;
  bool enable = 2;
}

message GetMemoryBallooningResponse {
  bool enabled = 1;
  bool memory_locked = 2;
  bool has_memballoon = 3;
  string memballoon_model = 4;
}

// defines on slave
service SlaveVirshService {
  rpc GetCpuFeatures(Empty) returns (GetCpuFeaturesResponse);
  rpc GetCPUXML(Empty) returns (CPUXMLResponse);

  rpc GetVMCPUXml(GetVmByNameRequest) returns (CPUXMLResponse);
  rpc UpdateVMCPUXml(UpdateVMCPUXmlRequest) returns (OkResponse);

  rpc CreateVm(CreateVmRequest) returns (OkResponse);

  rpc MigrateVM(MigrateVmRequest) returns (OkResponse);

  rpc ShutdownVM(Vm) returns (OkResponse);
  rpc ForceShutdownVM(Vm) returns (OkResponse);
  rpc StartVM(Vm) returns (OkResponse);
  rpc RemoveVM(Vm) returns (OkResponse);
  rpc RestartVM(Vm) returns (OkResponse);
  rpc PauseVM(Vm) returns (OkResponse);
  rpc ResumeVM(Vm) returns (OkResponse);
  rpc UndefineVM(Vm) returns (OkResponse);

  rpc GetAllVms(Empty) returns (GetAllVmsResponse);
  rpc GetVmByName(GetVmByNameRequest) returns (Vm);
  rpc RemoveIsoFromVm(Vm) returns (OkResponse);

  rpc ChangeNetwork(ChangeNetworkReq) returns (Empty);
  rpc AddNoVNCVideo(GetVmByNameRequest) returns (OkResponse);
  rpc RemoveNoVNCVideo(GetVmByNameRequest) returns (OkResponse);
  rpc GetNoVNCVideo(GetVmByNameRequest) returns (GetNoVNCVideoResponse);
  rpc GetMemoryBallooning(GetVmByNameRequest) returns (GetMemoryBallooningResponse);
  rpc SetMemoryBallooning(SetMemoryBallooningRequest) returns (OkResponse);

  // only sees machine name, cpuCount and memoryMB
  // cpuCount and memoryMB are the new values to set
  rpc EditVmResources(Vm) returns (OkResponse);

  rpc ColdMigrateVm(ColdMigrationRequest) returns (OkResponse);

  rpc FreezeDisk(Vm) returns (OkResponse);
  rpc UnFreezeDisk(Vm) returns (OkResponse);
  rpc ChangeVmPassword(ChangeVncPassword) returns (Empty);

  // CPU Pinning
  rpc ApplyCPUPinning(CPUPinningRequest) returns (OkResponse);
  rpc RemoveCPUPinning(GetVmByNameRequest) returns (OkResponse);
  rpc GetCPUPinning(GetVmByNameRequest) returns (CPUPinningResponse);
  rpc GetCPUTopology(Empty) returns (CPUTopologyResponse);

  // Host tuned-adm profiles
  rpc GetTunedAdmProfiles(Empty) returns (TunedAdmProfilesResponse);
  rpc SetTunedAdmProfile(SetTunedAdmProfileRequest) returns (SetTunedAdmProfileResponse);
}

// CPU Pinning messages
message CPUPinningRequest {
  string vm_name = 1;
  int32 range_start = 2;
  int32 range_end = 3;
  bool hyper_threading = 4;
  int32 socket_id = 5;
}

message CPUPinningInfo {
  int32 vcpu = 1;
  string cpuset = 2;
  bool is_ht = 3;
}

message CPUPinningResponse {
  bool has_pinning = 1;
  repeated CPUPinningInfo pins = 2;
  int32 range_start = 3;
  int32 range_end = 4;
  bool hyper_threading = 5;
  int32 socket_id = 6;
  string emulator_cpuset = 7;
}

message CPUCoreInfo {
  int32 core_index = 1;
  int32 physical_id = 2;
  repeated int32 siblings = 3;
}

message CPUSocketInfo {
  int32 socket_id = 1;
  repeated CPUCoreInfo cores = 2;
}

message CPUTopologyResponse {
  repeated CPUSocketInfo sockets = 1;
}

message TunedAdmProfileInfo {
  string name = 1;
  string description = 2;
  bool active = 3;
}

message TunedAdmProfilesResponse {
  repeated TunedAdmProfileInfo profiles = 1;
  string current_active_profile = 2;
}

message SetTunedAdmProfileRequest {
  string profile = 1;
}

message SetTunedAdmProfileResponse {
  bool ok = 1;
  string message = 2;
  string current_active_profile = 3;
}
