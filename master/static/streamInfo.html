<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Stream Analytics Dashboard</title>
	<style>
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}

		body {
			font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			color: #333;
			padding: 20px;
			min-height: 100vh;
		}

		.dashboard {
			max-width: 1600px;
			margin: 0 auto;
		}

		h1 {
			color: white;
			text-align: center;
			margin-bottom: 30px;
			font-size: 2.5em;
			text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
		}

		.refresh-btn {
			display: block;
			margin: 0 auto 20px;
			padding: 12px 30px;
			background: #4CAF50;
			color: white;
			border: none;
			border-radius: 25px;
			font-size: 16px;
			cursor: pointer;
			transition: all 0.3s;
			box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
		}

		.refresh-btn:hover {
			background: #45a049;
			transform: translateY(-2px);
			box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
		}

		.grid {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
			gap: 20px;
			margin-bottom: 20px;
		}

		.panel {
			background: white;
			border-radius: 15px;
			padding: 25px;
			box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
			transition: transform 0.3s, box-shadow 0.3s;
		}

		.panel:hover {
			transform: translateY(-5px);
			box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
		}

		.panel-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 20px;
			padding-bottom: 15px;
			border-bottom: 3px solid #667eea;
		}

		.panel-title {
			font-size: 1.4em;
			font-weight: 600;
			color: #667eea;
		}

		.panel-badge {
			background: #667eea;
			color: white;
			padding: 5px 15px;
			border-radius: 20px;
			font-size: 0.9em;
			font-weight: 600;
		}

		.stat-group {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
			gap: 15px;
			margin-bottom: 15px;
		}

		.stat {
			text-align: center;
			padding: 15px;
			background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
			border-radius: 10px;
		}

		.stat-value {
			font-size: 2em;
			font-weight: bold;
			color: #667eea;
		}

		.stat-label {
			font-size: 0.85em;
			color: #666;
			margin-top: 5px;
			text-transform: uppercase;
			letter-spacing: 0.5px;
		}

		.list-item {
			display: flex;
			justify-content: space-between;
			align-items: center;
			padding: 12px;
			margin-bottom: 8px;
			background: #f8f9fa;
			border-radius: 8px;
			border-left: 4px solid #667eea;
			transition: background 0.2s;
		}

		.list-item:hover {
			background: #e9ecef;
		}

		.list-item-left {
			display: flex;
			align-items: center;
			gap: 10px;
			flex: 1;
		}

		.list-item-right {
			text-align: right;
		}

		.country-flag {
			font-size: 1.5em;
		}

		.progress-bar {
			width: 100%;
			height: 8px;
			background: #e9ecef;
			border-radius: 4px;
			overflow: hidden;
			margin-top: 5px;
		}

		.progress-fill {
			height: 100%;
			background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
			transition: width 0.3s;
		}

		.chart-container {
			margin-top: 20px;
		}

		.bar-chart {
			display: flex;
			flex-direction: column;
			gap: 10px;
		}

		.bar-item {
			display: flex;
			align-items: center;
			gap: 10px;
		}

		.bar-label {
			min-width: 100px;
			font-size: 0.9em;
			font-weight: 500;
		}

		.bar-visual {
			flex: 1;
			height: 30px;
			background: #e9ecef;
			border-radius: 5px;
			position: relative;
			overflow: hidden;
		}

		.bar-fill {
			height: 100%;
			background: linear-gradient(90deg, #4CAF50 0%, #8BC34A 100%);
			display: flex;
			align-items: center;
			padding: 0 10px;
			color: white;
			font-size: 0.85em;
			font-weight: 600;
			transition: width 0.5s ease-out;
		}

		.hour-grid {
			display: grid;
			grid-template-columns: repeat(12, 1fr);
			gap: 5px;
			margin-top: 15px;
		}

		.hour-cell {
			aspect-ratio: 1;
			display: flex;
			flex-direction: column;
			align-items: center;
			justify-content: center;
			background: #f8f9fa;
			border-radius: 8px;
			font-size: 0.75em;
			transition: all 0.3s;
			cursor: pointer;
		}

		.hour-cell:hover {
			transform: scale(1.05);
			box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
		}

		.hour-label {
			font-weight: 600;
			color: #666;
		}

		.hour-value {
			font-size: 0.9em;
			color: #667eea;
			font-weight: bold;
		}

		.loading {
			text-align: center;
			padding: 40px;
			color: #666;
			font-size: 1.2em;
		}

		.error {
			background: #f8d7da;
			color: #721c24;
			padding: 15px;
			border-radius: 8px;
			border-left: 4px solid #f5c6cb;
		}

		.metric-row {
			display: flex;
			justify-content: space-between;
			padding: 10px 0;
			border-bottom: 1px solid #e9ecef;
		}

		.metric-row:last-child {
			border-bottom: none;
		}

		.metric-label {
			color: #666;
			font-weight: 500;
		}

		.metric-value {
			color: #667eea;
			font-weight: 600;
		}

		.heatmap-grid {
			display: grid;
			grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
			gap: 10px;
			margin-top: 15px;
		}

		.heatmap-point {
			padding: 12px;
			border-radius: 8px;
			text-align: center;
			transition: transform 0.2s;
			cursor: pointer;
		}

		.heatmap-point:hover {
			transform: scale(1.05);
		}

		.wide-panel {
			grid-column: 1 / -1;
		}

		@media (max-width: 768px) {
			.grid {
				grid-template-columns: 1fr;
			}

			h1 {
				font-size: 1.8em;
			}

			.hour-grid {
				grid-template-columns: repeat(6, 1fr);
			}
		}

		.session-distribution {
			display: flex;
			flex-direction: column;
			gap: 10px;
		}

		.session-item {
			background: #f8f9fa;
			padding: 12px;
			border-radius: 8px;
			display: flex;
			justify-content: space-between;
			align-items: center;
		}

		.byte-size {
			font-size: 0.85em;
			color: #666;
		}

		.scrollable-list {
			max-height: 400px;
			overflow-y: auto;
			padding-right: 10px;
		}

		.scrollable-list::-webkit-scrollbar {
			width: 8px;
		}

		.scrollable-list::-webkit-scrollbar-track {
			background: #f1f1f1;
			border-radius: 4px;
		}

		.scrollable-list::-webkit-scrollbar-thumb {
			background: #667eea;
			border-radius: 4px;
		}

		.scrollable-list::-webkit-scrollbar-thumb:hover {
			background: #764ba2;
		}
	</style>
</head>

<body>
	<div class="dashboard">
		<h1>üåê Stream Analytics Dashboard</h1>

		<button class="refresh-btn" onclick="loadAllData()">üîÑ Refresh Data</button>

		<!-- Summary Panel -->
		<div class="grid">
			<div class="panel" id="summary-panel">
				<div class="panel-header">
					<span class="panel-title">üìä Overview</span>
				</div>
				<div class="loading">Loading...</div>
			</div>

			<!-- Protocol Stats Panel -->
			<div class="panel" id="protocol-panel">
				<div class="panel-header">
					<span class="panel-title">üîå Protocol Statistics</span>
				</div>
				<div class="loading">Loading...</div>
			</div>

			<!-- Top Talkers Panel -->
			<div class="panel" id="talkers-panel">
				<div class="panel-header">
					<span class="panel-title">üí¨ Top Talkers</span>
				</div>
				<div class="loading">Loading...</div>
			</div>
		</div>

		<!-- Hourly Activity Panel (Wide) -->
		<div class="grid">
			<div class="panel wide-panel" id="hourly-panel">
				<div class="panel-header">
					<span class="panel-title">‚è∞ 24-Hour Activity Heatmap</span>
				</div>
				<div class="loading">Loading...</div>
			</div>
		</div>

		<!-- Session Distribution Panel (Wide) -->
		<div class="grid">
			<div class="panel wide-panel" id="session-panel">
				<div class="panel-header">
					<span class="panel-title">‚è±Ô∏è Session Duration Distribution</span>
				</div>
				<div class="loading">Loading...</div>
			</div>
		</div>

		<!-- Countries & Upstreams -->
		<div class="grid">
			<!-- All Countries Panel -->
			<div class="panel" id="countries-panel">
				<div class="panel-header">
					<span class="panel-title">üåç All Countries</span>
					<span class="panel-badge" id="country-count">0</span>
				</div>
				<div class="loading">Loading...</div>
			</div>

			<!-- Upstream Stats Panel -->
			<div class="panel" id="upstream-panel">
				<div class="panel-header">
					<span class="panel-title">üîÑ Upstream Servers</span>
				</div>
				<div class="loading">Loading...</div>
			</div>
		</div>

		<!-- Geographic Heatmap Panel (Wide) -->
		<div class="grid">
			<div class="panel wide-panel" id="heatmap-panel">
				<div class="panel-header">
					<span class="panel-title">üó∫Ô∏è Geographic Heatmap</span>
				</div>
				<div class="loading">Loading...</div>
			</div>
		</div>

		<!-- Daily Visitors Panel (Wide) -->
		<div class="grid">
			<div class="panel wide-panel" id="daily-panel">
				<div class="panel-header">
					<span class="panel-title">üìÖ Daily Visitor Trends</span>
				</div>
				<div class="loading">Loading...</div>
			</div>
		</div>
	</div>

	<script>
		function formatBytes(bytes) {
			if (bytes === 0) return '0 B';
			const k = 1024;
			const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
			const i = Math.floor(Math.log(bytes) / Math.log(k));
			return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
		}

		function formatNumber(num) {
			return new Intl.NumberFormat().format(num);
		}

		function getCountryFlag(isoCode) {
			if (!isoCode || isoCode === '??') return 'üè≥Ô∏è';
			const codePoints = isoCode
				.toUpperCase()
				.split('')
				.map(char => 127397 + char.charCodeAt());
			return String.fromCodePoint(...codePoints);
		}

		function getHeatColor(weight) {
			const colors = [
				{ threshold: 0, color: '#e3f2fd' },
				{ threshold: 0.2, color: '#90caf9' },
				{ threshold: 0.4, color: '#42a5f5' },
				{ threshold: 0.6, color: '#1e88e5' },
				{ threshold: 0.8, color: '#1565c0' },
				{ threshold: 1, color: '#0d47a1' }
			];

			for (let i = colors.length - 1; i >= 0; i--) {
				if (weight >= colors[i].threshold) {
					return colors[i].color;
				}
			}
			return colors[0].color;
		}

		async function loadSummary() {
			try {
				const response = await fetch('/api/streamInfo/summary');
				const data = await response.json();

				const panel = document.getElementById('summary-panel');
				panel.innerHTML = `
                    <div class="panel-header">
                        <span class="panel-title">üìä Overview</span>
                        <span class="panel-badge">${formatNumber(data.total_connections)} connections</span>
                    </div>
                    <div class="stat-group">
                        <div class="stat">
                            <div class="stat-value">${formatNumber(data.unique_clients)}</div>
                            <div class="stat-label">Unique Clients</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value">${formatBytes(data.total_bytes_sent)}</div>
                            <div class="stat-label">Sent</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value">${formatBytes(data.total_bytes_received)}</div>
                            <div class="stat-label">Received</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value">${data.avg_session_seconds.toFixed(2)}s</div>
                            <div class="stat-label">Avg Session</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value">${data.connections_per_minute.toFixed(2)}</div>
                            <div class="stat-label">Conn/Min</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value">${data.total_tracked_countries}</div>
                            <div class="stat-label">Countries</div>
                        </div>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Window Start:</span>
                        <span class="metric-value">${new Date(data.window.start).toLocaleString()}</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Window End:</span>
                        <span class="metric-value">${new Date(data.window.end).toLocaleString()}</span>
                    </div>
                `;

				// Load top talkers in separate panel
				const talkersPanel = document.getElementById('talkers-panel');
				talkersPanel.innerHTML = `
                    <div class="panel-header">
                        <span class="panel-title">üí¨ Top Talkers</span>
                        <span class="panel-badge">${data.top_talkers.length}</span>
                    </div>
                    ${data.top_talkers.map(talker => `
                        <div class="list-item">
                            <div class="list-item-left">
                                <span style="font-weight: 600;">${talker.client_ip}</span>
                                ${talker.location ? `
                                    <span class="country-flag">${getCountryFlag(talker.location.country_iso)}</span>
                                    <span style="font-size: 0.85em; color: #666;">
                                        ${talker.location.city ? talker.location.city + ', ' : ''}${talker.location.country}
                                    </span>
                                ` : ''}
                            </div>
                            <div class="list-item-right">
                                <div style="font-weight: 600; color: #667eea;">${formatNumber(talker.connections)} conn</div>
                                <div class="byte-size">‚Üë${formatBytes(talker.bytes_sent)} ‚Üì${formatBytes(talker.bytes_received)}</div>
                            </div>
                        </div>
                    `).join('')}
                `;
			} catch (error) {
				console.error('Error loading summary:', error);
				document.getElementById('summary-panel').innerHTML = '<div class="error">Failed to load summary data</div>';
			}
		}

		async function loadAllCountries() {
			try {
				const response = await fetch('/api/streamInfo/countries');
				const data = await response.json();

				document.getElementById('country-count').textContent = data.total_countries;

				const panel = document.getElementById('countries-panel');
				panel.innerHTML = `
                    <div class="panel-header">
                        <span class="panel-title">üåç All Countries</span>
                        <span class="panel-badge">${data.total_countries} countries</span>
                    </div>
                    <div class="scrollable-list">
                        ${data.countries.map(country => `
                            <div class="list-item">
                                <div class="list-item-left">
                                    <span class="country-flag">${getCountryFlag(country.iso_code)}</span>
                                    <span style="font-weight: 600;">${country.country}</span>
                                </div>
                                <div class="list-item-right">
                                    <div style="font-weight: 600; color: #667eea;">${formatNumber(country.visitors)}</div>
                                    <div class="byte-size">${country.percentage.toFixed(1)}%</div>
                                </div>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${country.percentage}%"></div>
                            </div>
                        `).join('')}
                    </div>
                `;
			} catch (error) {
				console.error('Error loading countries:', error);
				document.getElementById('countries-panel').innerHTML = '<div class="error">Failed to load country data</div>';
			}
		}

		async function loadProtocolStats() {
			try {
				const response = await fetch('/api/streamInfo/protocols');
				const data = await response.json();

				const panel = document.getElementById('protocol-panel');
				panel.innerHTML = `
                    <div class="panel-header">
                        <span class="panel-title">üîå Protocol Statistics</span>
                        <span class="panel-badge">${data.protocols.length}</span>
                    </div>
                    <div class="bar-chart">
                        ${data.protocols.map(protocol => `
                            <div class="bar-item">
                                <div class="bar-label">${protocol.protocol}</div>
                                <div class="bar-visual">
                                    <div class="bar-fill" style="width: ${protocol.percentage}%">
                                        ${formatNumber(protocol.connections)} (${protocol.percentage.toFixed(1)}%)
                                    </div>
                                </div>
                            </div>
                            <div style="font-size: 0.8em; color: #666; margin-left: 110px; margin-bottom: 10px;">
                                ‚Üë${formatBytes(protocol.bytes_sent)} ‚Üì${formatBytes(protocol.bytes_received)} 
                                ‚Ä¢ Avg: ${protocol.avg_session_seconds.toFixed(2)}s
                            </div>
                        `).join('')}
                    </div>
                `;
			} catch (error) {
				console.error('Error loading protocols:', error);
				document.getElementById('protocol-panel').innerHTML = '<div class="error">Failed to load protocol data</div>';
			}
		}

		async function loadHourlyActivity() {
			try {
				const response = await fetch('/api/streamInfo/hourly');
				const data = await response.json();

				const maxConnections = Math.max(...data.hours.map(h => h.connections));

				const panel = document.getElementById('hourly-panel');
				panel.innerHTML = `
                    <div class="panel-header">
                        <span class="panel-title">‚è∞ 24-Hour Activity Heatmap</span>
                        <span class="panel-badge">Peak: ${formatNumber(maxConnections)} connections</span>
                    </div>
                    <div class="hour-grid">
                        ${data.hours.map(hour => {
					const intensity = maxConnections > 0 ? hour.connections / maxConnections : 0;
					const bgColor = getHeatColor(intensity);
					const textColor = intensity > 0.5 ? 'white' : '#333';
					return `
                                <div class="hour-cell" style="background: ${bgColor}; color: ${textColor};" 
                                     title="${hour.connections} connections, ${hour.unique_ips} unique IPs">
                                    <div class="hour-label">${hour.hour}:00</div>
                                    <div class="hour-value">${hour.connections}</div>
                                </div>
                            `;
				}).join('')}
                    </div>
                `;
			} catch (error) {
				console.error('Error loading hourly activity:', error);
				document.getElementById('hourly-panel').innerHTML = '<div class="error">Failed to load hourly data</div>';
			}
		}

		async function loadUpstreamStats() {
			try {
				const response = await fetch('/api/streamInfo/upstreams');
				const data = await response.json();

				const panel = document.getElementById('upstream-panel');
				panel.innerHTML = `
                    <div class="panel-header">
                        <span class="panel-title">üîÑ Upstream Servers</span>
                        <span class="panel-badge">${data.total_upstreams}</span>
                    </div>
                    <div class="scrollable-list">
                        ${data.upstreams.map(upstream => `
                            <div class="list-item">
                                <div class="list-item-left">
                                    <span style="font-weight: 600; font-family: monospace;">${upstream.upstream_addr}</span>
                                </div>
                                <div class="list-item-right">
                                    <div style="font-weight: 600; color: #667eea;">${formatNumber(upstream.connections)} conn</div>
                                    <div class="byte-size">${upstream.unique_clients} clients ‚Ä¢ ${upstream.percentage.toFixed(1)}%</div>
                                </div>
                            </div>
                            <div style="font-size: 0.8em; color: #666; margin-left: 12px; margin-bottom: 8px;">
                                ‚Üë${formatBytes(upstream.bytes_sent)} ‚Üì${formatBytes(upstream.bytes_received)} 
                                ‚Ä¢ Avg: ${upstream.avg_session_seconds.toFixed(2)}s
                            </div>
                        `).join('')}
                    </div>
                `;
			} catch (error) {
				console.error('Error loading upstreams:', error);
				document.getElementById('upstream-panel').innerHTML = '<div class="error">Failed to load upstream data</div>';
			}
		}

		async function loadGeographicHeatmap() {
			try {
				const response = await fetch('/api/streamInfo/heatmap');
				const data = await response.json();

				const panel = document.getElementById('heatmap-panel');
				panel.innerHTML = `
                    <div class="panel-header">
                        <span class="panel-title">üó∫Ô∏è Geographic Heatmap</span>
                        <span class="panel-badge">${data.total_points} locations</span>
                    </div>
                    <div class="heatmap-grid">
                        ${data.points.map(point => {
					const bgColor = getHeatColor(point.weight);
					const textColor = point.weight > 0.5 ? 'white' : '#333';
					return `
                                <div class="heatmap-point" style="background: ${bgColor}; color: ${textColor};">
                                    <div style="font-size: 2em; margin-bottom: 5px;">${getCountryFlag(point.country_iso)}</div>
                                    <div style="font-weight: 600;">${point.city || point.country}</div>
                                    <div style="font-size: 0.9em; margin-top: 5px;">${formatNumber(point.connections)} connections</div>
                                    <div style="font-size: 0.75em; opacity: 0.8; margin-top: 3px;">
                                        ${point.latitude.toFixed(2)}¬∞, ${point.longitude.toFixed(2)}¬∞
                                    </div>
                                </div>
                            `;
				}).join('')}
                    </div>
                `;
			} catch (error) {
				console.error('Error loading heatmap:', error);
				document.getElementById('heatmap-panel').innerHTML = '<div class="error">Failed to load heatmap data</div>';
			}
		}

		async function loadSessionDistribution() {
			try {
				const response = await fetch('/api/streamInfo/sessions');
				const data = await response.json();

				const maxCount = Math.max(...data.ranges.map(r => r.count));

				const panel = document.getElementById('session-panel');
				panel.innerHTML = `
                    <div class="panel-header">
                        <span class="panel-title">‚è±Ô∏è Session Duration Distribution</span>
                    </div>
                    <div class="bar-chart">
                        ${data.ranges.map(range => `
                            <div class="bar-item">
                                <div class="bar-label" style="min-width: 140px;">${range.label}</div>
                                <div class="bar-visual">
                                    <div class="bar-fill" style="width: ${(range.count / maxCount * 100)}%; background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);">
                                        ${formatNumber(range.count)} (${range.percentage.toFixed(1)}%)
                                    </div>
                                </div>
                            </div>
                            <div style="font-size: 0.8em; color: #666; margin-left: 150px; margin-bottom: 10px;">
                                Total data: ${formatBytes(range.total_bytes)}
                            </div>
                        `).join('')}
                    </div>
                `;
			} catch (error) {
				console.error('Error loading session distribution:', error);
				document.getElementById('session-panel').innerHTML = '<div class="error">Failed to load session data</div>';
			}
		}

		async function loadDailyVisitors() {
			try {
				const response = await fetch('/api/streamInfo/visitors');
				const data = await response.json();

				const panel = document.getElementById('daily-panel');
				panel.innerHTML = `
                    <div class="panel-header">
                        <span class="panel-title">üìÖ Daily Visitor Trends</span>
                        <span class="panel-badge">${data.length} days</span>
                    </div>
                    <div class="scrollable-list">
                        ${data.map(day => `
                            <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <h3 style="color: #667eea; margin: 0;">${day.day}</h3>
                                    <div style="text-align: right;">
                                        <div style="font-size: 1.5em; font-weight: 600; color: #667eea;">
                                            ${formatNumber(day.unique_visitors)}
                                        </div>
                                        <div style="font-size: 0.8em; color: #666;">unique visitors</div>
                                    </div>
                                </div>
                                <div class="stat-group" style="grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));">
                                    <div class="stat" style="padding: 10px;">
                                        <div class="stat-value" style="font-size: 1.3em;">${formatNumber(day.total_connections)}</div>
                                        <div class="stat-label" style="font-size: 0.75em;">Connections</div>
                                    </div>
                                    <div class="stat" style="padding: 10px;">
                                        <div class="stat-value" style="font-size: 1.3em;">${formatBytes(day.bytes_sent)}</div>
                                        <div class="stat-label" style="font-size: 0.75em;">Sent</div>
                                    </div>
                                    <div class="stat" style="padding: 10px;">
                                        <div class="stat-value" style="font-size: 1.3em;">${formatBytes(day.bytes_received)}</div>
                                        <div class="stat-label" style="font-size: 0.75em;">Received</div>
                                    </div>
                                    <div class="stat" style="padding: 10px;">
                                        <div class="stat-value" style="font-size: 1.3em;">${day.avg_session_seconds.toFixed(1)}s</div>
                                        <div class="stat-label" style="font-size: 0.75em;">Avg Session</div>
                                    </div>
                                </div>
                                ${day.country_breakdown && day.country_breakdown.length > 0 ? `
                                    <div style="margin-top: 10px;">
                                        <div style="font-size: 0.9em; font-weight: 600; color: #666; margin-bottom: 5px;">Top Countries:</div>
                                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                            ${day.country_breakdown.map(country => `
                                                <span style="background: white; padding: 5px 10px; border-radius: 5px; font-size: 0.85em;">
                                                    ${getCountryFlag(country.iso_code)} ${country.country} (${country.visitors})
                                                </span>
                                            `).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                                ${day.change ? `
                                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #dee2e6; font-size: 0.85em; color: #666;">
                                        Changes: 
                                        <span style="color: ${day.change.unique_visitors_pct >= 0 ? '#4CAF50' : '#f44336'};">
                                            ${day.change.unique_visitors_pct >= 0 ? '‚ñ≤' : '‚ñº'} ${Math.abs(day.change.unique_visitors_pct).toFixed(1)}% visitors
                                        </span>
                                        ‚Ä¢
                                        <span style="color: ${day.change.bytes_sent_pct >= 0 ? '#4CAF50' : '#f44336'};">
                                            ${day.change.bytes_sent_pct >= 0 ? '‚ñ≤' : '‚ñº'} ${Math.abs(day.change.bytes_sent_pct).toFixed(1)}% sent
                                        </span>
                                    </div>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>
                `;
			} catch (error) {
				console.error('Error loading daily visitors:', error);
				document.getElementById('daily-panel').innerHTML = '<div class="error">Failed to load daily data</div>';
			}
		}

		async function loadAllData() {
			await Promise.all([
				loadSummary(),
				loadAllCountries(),
				loadProtocolStats(),
				loadHourlyActivity(),
				loadUpstreamStats(),
				loadGeographicHeatmap(),
				loadSessionDistribution(),
				loadDailyVisitors()
			]);
		}

		// Load data on page load
		loadAllData();

		// Auto-refresh every 30 seconds
		setInterval(loadAllData, 30000);
	</script>
</body>

</html>