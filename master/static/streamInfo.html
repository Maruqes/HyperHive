<!DOCTYPE html>
<html lang="en" class="dark">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>HyperHive Stream Telemetry</title>
	<script src="https://cdn.tailwindcss.com"></script>
	<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
	<script src="https://cdn.jsdelivr.net/npm/d3-sankey@0.12"></script>
	<script src="https://cdn.jsdelivr.net/npm/topojson-client@3"></script>
	<script>
		tailwind.config = { darkMode: 'class', theme: { extend: { colors: { dark: { bg: '#0f172a', card: '#1e293b', border: '#334155' } } } } };
	</script>
	<style>
		:root {
			--bg: #040915;
			--panel: #0f172a;
			--panel-soft: #111f34;
			--panel-border: #1e293b;
			--accent: #38bdf8;
			--accent-2: #22d3ee;
			--text-soft: #94a3b8;
		}

		body {
			background-color: var(--bg);
			font-family: "IBM Plex Mono", "Fira Code", "SFMono-Regular", Menlo, monospace;
			letter-spacing: -0.01em;
		}

		h1,
		h2,
		h3,
		h4,
		h5,
		h6 {
			font-weight: 600;
			letter-spacing: -0.02em;
		}

		.stat-card {
			border: 1px solid var(--panel-border);
			background: radial-gradient(circle at top left, rgba(56, 189, 248, 0.08), transparent 55%) var(--panel);
			box-shadow: inset 0 1px 0 rgba(148, 163, 184, 0.07);
			transition: border-color 0.2s ease, transform 0.15s ease;
		}

		.stat-card:hover {
			border-color: var(--accent);
			transform: translateY(-1px);
		}

		.loader {
			border-top-color: var(--accent);
			animation: spinner 0.9s linear infinite
		}

		@keyframes spinner {
			0% {
				transform: rotate(0deg)
			}

			100% {
				transform: rotate(360deg)
			}
		}

		.table-row:hover {
			background-color: rgba(56, 189, 248, 0.08)
		}

		.table-row.clickable {
			cursor: pointer;
		}

		.table-row.clickable:hover {
			background-color: rgba(56, 189, 248, 0.18);
		}

		.table-container {
			max-height: 400px;
			overflow-y: auto;
		}

		.table-container::-webkit-scrollbar {
			width: 7px;
		}

		.table-container::-webkit-scrollbar-track {
			background: var(--panel-soft);
		}

		.table-container::-webkit-scrollbar-thumb {
			background: #3b4a62;
			border-radius: 4px;
		}

		.table-container::-webkit-scrollbar-thumb:hover {
			background: #4c5d7b;
		}

		.sankey-link {
			fill: none;
			stroke-opacity: 0.5
		}

		.sankey-link:hover {
			stroke-opacity: 0.8
		}

		.sankey-node rect {
			cursor: move;
			fill-opacity: 0.9;
			shape-rendering: crispEdges
		}

		.sankey-node text {
			pointer-events: none;
			text-shadow: 0 1px 0 #000
		}

		.nerd-chip {
			font-size: 0.65rem;
			text-transform: uppercase;
			letter-spacing: 0.25em;
			color: var(--text-soft);
		}

		.modal {
			display: none;
			position: fixed;
			z-index: 1000;
			left: 0;
			top: 0;
			width: 100%;
			height: 100%;
			background: rgba(2, 6, 23, 0.85);
			backdrop-filter: blur(4px);
			padding: 1.5rem;
		}

		.modal.active {
			display: flex;
			align-items: center;
			justify-content: center;
		}

		.modal-content {
			background: var(--panel);
			border: 1px solid var(--panel-border);
			border-radius: 10px;
			max-width: 920px;
			width: 100%;
			max-height: 82vh;
			overflow: hidden;
			box-shadow: 0 20px 60px rgba(0, 0, 0, 0.65);
			display: flex;
			flex-direction: column;
		}

		.modal-body {
			padding: 1.5rem;
			overflow-y: auto;
		}

		.modal-header {
			padding: 1.5rem;
			border-bottom: 1px solid var(--panel-border);
			background: linear-gradient(90deg, rgba(56, 189, 248, 0.08), transparent);
		}

		.modal-header h2 {
			font-size: 1.35rem;
			color: #e2e8f0;
		}

		.modal-close {
			color: var(--text-soft);
			font-size: 1rem;
			border: 1px solid var(--panel-border);
			padding: 0.25rem 0.8rem;
			border-radius: 6px;
			text-transform: uppercase;
			letter-spacing: 0.2em;
			background: rgba(15, 23, 42, 0.9);
		}

		.modal-close:hover {
			border-color: var(--accent);
			color: var(--accent);
		}

		.modal-metrics {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
			gap: 0.75rem;
			margin-bottom: 1.25rem;
		}

		.modal-metric {
			border: 1px solid var(--panel-border);
			border-radius: 6px;
			padding: 0.75rem;
			background: var(--panel-soft);
		}

		.modal-metric label {
			font-size: 0.7rem;
			text-transform: uppercase;
			letter-spacing: 0.2em;
			color: var(--text-soft);
		}

		.modal-metric span {
			font-size: 1.4rem;
			color: #f1f5f9;
		}

		.modal-table {
			max-height: 48vh;
		}

		.modal-table table {
			width: 100%;
		}

		.geo-map {
			position: relative;
			height: 500px;
			background: radial-gradient(ellipse at center, rgba(15, 23, 42, 0.95), rgba(2, 6, 23, 1));
			border-radius: 0.75rem;
			overflow: hidden;
			border: 1px solid var(--panel-border);
			cursor: grab;
		}

		.geo-map:active {
			cursor: grabbing;
		}

		.geo-map svg {
			width: 100%;
			height: 100%;
			display: block;
		}

		.geo-map .sphere {
			fill: radial-gradient(circle at 30% 30%, #1a2744, #0a1020);
			stroke: rgba(59, 130, 246, 0.3);
			stroke-width: 1.5;
		}

		.geo-map .graticule {
			fill: none;
			stroke: rgba(148, 163, 184, 0.1);
			stroke-width: 0.5;
		}

		.geo-map .country {
			cursor: pointer;
			transition: fill 0.2s ease, stroke 0.2s ease;
			stroke: rgba(148, 163, 184, 0.2);
			stroke-width: 0.5;
		}

		.geo-map .country:hover {
			stroke: rgba(96, 165, 250, 0.9);
			stroke-width: 1.5;
			filter: brightness(1.3);
		}

		.geo-map .country.selected {
			stroke: #fcd34d;
			stroke-width: 2;
			filter: brightness(1.5);
		}

		.geo-map-status {
			position: absolute;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
			font-size: 0.75rem;
			color: var(--text-soft);
			text-transform: uppercase;
			letter-spacing: 0.25em;
			pointer-events: none;
		}

		.geo-map-legend {
			position: absolute;
			right: 1rem;
			bottom: 1rem;
			background: rgba(2, 6, 23, 0.85);
			padding: 0.6rem 0.85rem;
			border-radius: 0.5rem;
			border: 1px solid rgba(59, 130, 246, 0.3);
			font-size: 0.65rem;
			text-transform: uppercase;
			letter-spacing: 0.15em;
			color: #cbd5f5;
			min-width: 140px;
			backdrop-filter: blur(10px);
		}

		.geo-map-controls {
			position: absolute;
			top: 1rem;
			right: 1rem;
			display: flex;
			gap: 0.5rem;
			z-index: 10;
		}

		.geo-map-controls button {
			background: rgba(2, 6, 23, 0.85);
			border: 1px solid rgba(59, 130, 246, 0.3);
			color: #cbd5f5;
			padding: 0.5rem;
			border-radius: 0.4rem;
			cursor: pointer;
			transition: all 0.2s ease;
			backdrop-filter: blur(10px);
			font-size: 0.75rem;
			min-width: 32px;
			height: 32px;
			display: flex;
			align-items: center;
			justify-content: center;
		}

		.geo-map-controls button:hover {
			background: rgba(59, 130, 246, 0.2);
			border-color: rgba(96, 165, 250, 0.5);
			transform: translateY(-1px);
		}

		.geo-map-controls button:active {
			transform: translateY(0);
		}

		.geo-map-tooltip {
			position: absolute;
			background: rgba(2, 6, 23, 0.95);
			color: white;
			padding: 0.5rem 0.75rem;
			border-radius: 0.4rem;
			border: 1px solid rgba(59, 130, 246, 0.4);
			font-size: 0.75rem;
			pointer-events: none;
			z-index: 1000;
			display: none;
			backdrop-filter: blur(10px);
		}
	</style>
</head>

<body class="bg-slate-900 text-gray-100">
	<header class="border-b border-slate-800/70 bg-slate-900/70 backdrop-blur">
		<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
			<div class="flex justify-between items-end flex-wrap gap-4">
				<div>
					<p class="nerd-chip">Stream telemetry</p>
					<h1 class="text-3xl font-semibold text-cyan-200 tracking-tight mt-1">HyperHive Stream Board</h1>
					<p class="text-xs text-slate-400 font-mono mt-1">Source: npm stream-proxy.log</p>
				</div>
				<div class="flex items-center gap-4 flex-wrap">
					<div class="flex items-center space-x-2">
						<label class="text-xs uppercase tracking-[0.2em] text-slate-500">from</label>
						<input type="date" id="startDate"
							class="bg-slate-800 text-white px-3 py-1 rounded border border-slate-700 text-sm focus:border-cyan-400 focus:outline-none">
					</div>
					<div class="flex items-center space-x-2">
						<label class="text-xs uppercase tracking-[0.2em] text-slate-500">to</label>
						<input type="date" id="endDate"
							class="bg-slate-800 text-white px-3 py-1 rounded border border-slate-700 text-sm focus:border-cyan-400 focus:outline-none">
					</div>
					<button onclick="refreshData()"
						class="flex items-center gap-2 bg-cyan-600/70 hover:bg-cyan-500 text-white px-4 py-2 rounded border border-cyan-300/40 transition-colors">
						<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
								d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
							</path>
						</svg>
						<span>Resync</span>
					</button>
					<span id="lastUpdate" class="text-xs text-slate-500 font-mono"></span>
				</div>
			</div>
		</div>
	</header>
	<main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
		<div id="loading" class="flex justify-center items-center py-20">
			<div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-700 h-12 w-12"></div>
		</div>
		<div id="dashboard" class="hidden space-y-6">
			<div id="dateInfo" class="bg-slate-900/70 border border-slate-800 rounded-lg p-4 shadow-inner">
				<div class="flex flex-wrap gap-6 text-sm font-mono text-slate-300">
					<div>
						<p class="text-xs uppercase tracking-[0.25em] text-slate-500">range</p>
						<p id="datasetRange" class="text-cyan-200 mt-1">-</p>
					</div>
					<div>
						<p class="text-xs uppercase tracking-[0.25em] text-slate-500">days</p>
						<p class="mt-1 text-white"><span id="datasetDays" class="text-cyan-200">-</span></p>
					</div>
					<div>
						<p class="text-xs uppercase tracking-[0.25em] text-slate-500">entries</p>
						<p class="mt-1 text-white"><span id="datasetTotal" class="text-cyan-200">-</span></p>
					</div>
				</div>
			</div>
			<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
				<div class="stat-card bg-slate-800 rounded-lg shadow-xl p-6 border border-slate-700">
					<div class="flex items-center justify-between">
						<div>
							<p class="text-sm font-medium text-gray-400">Total Connections</p>
							<p id="totalConns" class="text-3xl font-bold text-white mt-2">-</p>
						</div>
						<div class="bg-blue-900 p-3 rounded-full"><svg class="w-6 h-6 text-blue-400" fill="none"
								stroke="currentColor" viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
									d="M13 10V3L4 14h7v7l9-11h-7z"></path>
							</svg></div>
					</div>
					<p class="text-xs text-gray-400 mt-3"><span id="successRate"
							class="text-green-400 font-semibold">-</span> success rate</p>
				</div>
				<div class="stat-card bg-slate-800 rounded-lg shadow-xl p-6 border border-slate-700">
					<div class="flex items-center justify-between">
						<div>
							<p class="text-sm font-medium text-gray-400">Unique IPs</p>
							<p id="uniqueIPs" class="text-3xl font-bold text-white mt-2">-</p>
						</div>
						<div class="bg-green-900 p-3 rounded-full"><svg class="w-6 h-6 text-green-400" fill="none"
								stroke="currentColor" viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
									d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z">
								</path>
							</svg></div>
					</div>
					<p class="text-xs text-gray-400 mt-3">From <span id="uniqueCountries"
							class="font-semibold text-gray-200">-</span> countries</p>
				</div>
				<div class="stat-card bg-slate-800 rounded-lg shadow-xl p-6 border border-slate-700">
					<div class="flex items-center justify-between">
						<div>
							<p class="text-sm font-medium text-gray-400">Total Traffic</p>
							<p id="totalBytes" class="text-3xl font-bold text-white mt-2">-</p>
						</div>
						<div class="bg-purple-900 p-3 rounded-full"><svg class="w-6 h-6 text-purple-400" fill="none"
								stroke="currentColor" viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
									d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12">
								</path>
							</svg></div>
					</div>
					<p class="text-xs text-gray-400 mt-3"><span id="avgSession"
							class="font-semibold text-gray-200">-</span>s avg session</p>
				</div>
				<div class="stat-card bg-slate-800 rounded-lg shadow-xl p-6 border border-slate-700">
					<div class="flex items-center justify-between">
						<div>
							<p class="text-sm font-medium text-gray-400">Failed Connections</p>
							<p id="failedConns" class="text-3xl font-bold text-red-400 mt-2">-</p>
						</div>
						<div class="bg-red-900 p-3 rounded-full"><svg class="w-6 h-6 text-red-400" fill="none"
								stroke="currentColor" viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
									d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z">
								</path>
							</svg></div>
					</div>
					<p id="dateRange" class="text-xs text-gray-400 mt-3">-</p>
				</div>
			</div>
			<div
				class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-lg shadow-2xl p-6 border-2 border-purple-500">
				<div class="flex justify-between items-center mb-4">
					<div>
						<h3 class="text-2xl font-bold text-white flex items-center"><svg
								class="w-8 h-8 mr-2 text-purple-400" fill="none" stroke="currentColor"
								viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
									d="M13 10V3L4 14h7v7l9-11h-7z"></path>
							</svg>Connection Flow Analysis</h3>
						<p class="text-sm text-gray-400 mt-1">Visualizing traffic flow from countries to destination
							ports</p>
					</div>
					<div class="text-right">
						<p class="text-sm text-gray-400">Showing top <span id="flowCount"
								class="font-bold text-purple-400">-</span> flows</p>
						<p class="text-xs text-gray-500">Hover over flows for details</p>
					</div>
				</div>
				<div id="sankeyChart"
					style="width:100%;height:600px;background:rgba(15,23,42,0.5);border-radius:8px;overflow:hidden">
				</div>
			</div>
			<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
				<div class="bg-slate-800 rounded-lg shadow-xl p-6 border border-slate-700">
					<h3 class="text-lg font-semibold text-white mb-4">Activity</h3>
					<div style="position:relative;height:250px"><canvas id="dailyChart"></canvas></div>
				</div>
				<div class="bg-slate-800 rounded-lg shadow-xl p-6 border border-slate-700">
					<h3 class="text-lg font-semibold text-white mb-4">Hourly Distribution</h3>
					<div style="position:relative;height:250px"><canvas id="hourlyChart"></canvas></div>
				</div>
			</div>
			<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
				<div class="bg-slate-800 rounded-lg shadow-xl border border-slate-700 lg:col-span-2">
					<div class="px-6 py-4 border-b border-slate-700">
						<h3 class="text-lg font-semibold text-white">Timeline Telemetry</h3>
						<p id="timelineSummary" class="text-xs text-slate-400 font-mono">Connections + failure rate per
							hour.</p>
					</div>
					<div class="p-6">
						<div style="position:relative;height:320px"><canvas id="timelineChart"></canvas></div>
					</div>
				</div>
				<div class="bg-slate-800 rounded-lg shadow-xl border border-slate-700">
					<div class="px-6 py-4 border-b border-slate-700 flex items-center justify-between">
						<div>
							<h3 class="text-lg font-semibold text-white">Signal Monitor</h3>
							<p class="text-xs text-slate-400 font-mono">Auto-labeled anomalies in the timeline.</p>
						</div>
						<span id="anomalyCount" class="text-xs text-slate-400 font-mono">No signals</span>
					</div>
					<div id="anomalyList" class="p-6 space-y-4"></div>
				</div>
			</div>
			<div class="bg-slate-800 rounded-lg shadow-xl border border-slate-700">
				<div class="px-6 py-4 border-b border-slate-700 flex flex-wrap items-center justify-between gap-4">
					<div>
						<h3 class="text-lg font-semibold text-white">Server Activity</h3>
						<p class="text-xs text-slate-400 font-mono">Per-server daily trend and hourly distribution.</p>
					</div>
					<div class="flex items-center gap-3 flex-wrap">
						<select id="serverActivitySelect" onchange="handleServerActivityChange(this.value)"
							class="bg-slate-900 border border-slate-700 text-sm text-white px-3 py-2 rounded focus:border-cyan-400 focus:outline-none"
							style="min-width: 180px;">
							<option value="">No upstreams</option>
						</select>
						<button onclick="refreshServerActivity(true)"
							class="text-xs uppercase tracking-[0.3em] text-slate-300 border border-slate-600 px-3 py-2 rounded hover:text-cyan-200 hover:border-cyan-400 transition">
							Resample
						</button>
						<span id="serverActivityStatus" class="text-xs text-slate-500 font-mono">Select a server.</span>
					</div>
				</div>
				<div class="p-6 grid grid-cols-1 lg:grid-cols-2 gap-6">
					<div>
						<p class="text-xs uppercase tracking-[0.3em] text-slate-500 mb-2">Daily Activity</p>
						<div style="position:relative;height:280px">
							<canvas id="serverDailyChart"></canvas>
						</div>
					</div>
					<div>
						<p class="text-xs uppercase tracking-[0.3em] text-slate-500 mb-2">Hourly Distribution</p>
						<div style="position:relative;height:280px">
							<canvas id="serverHourlyChart"></canvas>
						</div>
					</div>
				</div>
			</div>
			<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
				<div class="bg-slate-800 rounded-lg shadow-xl border border-slate-700">
					<div class="px-6 py-4 border-b border-slate-700">
						<h3 class="text-lg font-semibold text-white">Failure Hotspots</h3>
						<p class="text-xs text-slate-400 font-mono">Top hours ranked by failure rate.</p>
					</div>
					<div class="table-container">
						<table class="min-w-full divide-y divide-slate-700">
							<thead class="bg-slate-900 sticky top-0">
								<tr>
									<th
										class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">
										Window</th>
									<th
										class="px-6 py-3 text-right text-xs font-medium text-gray-400 uppercase tracking-wider">
										Connections</th>
									<th
										class="px-6 py-3 text-right text-xs font-medium text-gray-400 uppercase tracking-wider">
										Failure %</th>
									<th
										class="px-6 py-3 text-right text-xs font-medium text-gray-400 uppercase tracking-wider">
										Unique IPs</th>
								</tr>
							</thead>
							<tbody id="failureHotspotsTable" class="divide-y divide-slate-800"></tbody>
						</table>
					</div>
				</div>
				<div class="bg-slate-800 rounded-lg shadow-xl border border-slate-700">
					<div class="px-6 py-4 border-b border-slate-700">
						<h3 class="text-lg font-semibold text-white">Burst Detector</h3>
						<p class="text-xs text-slate-400 font-mono">Hours where connections spiked sharply.</p>
					</div>
					<div class="table-container">
						<table class="min-w-full divide-y divide-slate-700">
							<thead class="bg-slate-900 sticky top-0">
								<tr>
									<th
										class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">
										Window</th>
									<th
										class="px-6 py-3 text-right text-xs font-medium text-gray-400 uppercase tracking-wider">
										Δ Conns</th>
									<th
										class="px-6 py-3 text-right text-xs font-medium text-gray-400 uppercase tracking-wider">
										% Change</th>
									<th
										class="px-6 py-3 text-right text-xs font-medium text-gray-400 uppercase tracking-wider">
										Upstreams</th>
								</tr>
							</thead>
							<tbody id="burstDetectorTable" class="divide-y divide-slate-800"></tbody>
						</table>
					</div>
				</div>
			</div>
			<div class="bg-slate-800 rounded-lg shadow-xl border border-slate-700">
				<div class="px-6 py-4 border-b border-slate-700 flex items-center justify-between">
					<div>
						<h3 class="text-lg font-semibold text-white">Geographic Heat Map</h3>
						<p class="text-xs text-slate-400 font-mono">Traffic intensity per country (total bytes).</p>
					</div>
					<span id="geoMapSummary" class="text-xs text-slate-500 font-mono">Click a region</span>
				</div>
				<div class="p-6">
					<div id="geoMap" class="geo-map">
						<div id="geoMapStatus" class="geo-map-status">Loading map…</div>
					</div>
				</div>
				<div class="border-t border-slate-700 px-6 py-5 bg-slate-900/40">
					<div class="flex flex-wrap items-start justify-between gap-4">
						<div>
							<p class="nerd-chip">Country focus</p>
							<h4 id="countryDetailName" class="text-xl text-cyan-200 mt-1">Select a country</h4>
							<p id="countryDetailMeta" class="text-xs text-slate-400 font-mono mt-1">Click the map to
								load details.</p>
						</div>
						<button onclick="clearCountryDetail()"
							class="text-xs uppercase tracking-[0.3em] text-slate-400 border border-slate-700 px-3 py-1 rounded hover:text-cyan-200 hover:border-cyan-300 transition">
							Reset
						</button>
					</div>
					<div id="countryDetailStats"
						class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 mt-4 hidden">
						<div class="border border-slate-700 rounded-lg px-4 py-3 bg-slate-900/60">
							<p class="text-[0.65rem] uppercase tracking-[0.3em] text-slate-500">Unique IPs</p>
							<p id="countryDetailUniqueIPs" class="text-lg text-white font-semibold mt-1">-</p>
						</div>
						<div class="border border-slate-700 rounded-lg px-4 py-3 bg-slate-900/60">
							<p class="text-[0.65rem] uppercase tracking-[0.3em] text-slate-500">Bandwidth</p>
							<p id="countryDetailBytes" class="text-lg text-white font-semibold mt-1">-</p>
						</div>
						<div class="border border-slate-700 rounded-lg px-4 py-3 bg-slate-900/60">
							<p class="text-[0.65rem] uppercase tracking-[0.3em] text-slate-500">Avg Session</p>
							<p id="countryDetailAvg" class="text-lg text-white font-semibold mt-1">-</p>
						</div>
						<div class="border border-slate-700 rounded-lg px-4 py-3 bg-slate-900/60">
							<p class="text-[0.65rem] uppercase tracking-[0.3em] text-slate-500">Median Session</p>
							<p id="countryDetailMedian" class="text-lg text-white font-semibold mt-1">-</p>
						</div>
					</div>
					<div class="mt-5">
						<p class="text-xs text-slate-400 uppercase tracking-[0.3em] mb-2">Top IPs</p>
						<div class="table-container" style="max-height: 220px;">
							<table class="min-w-full divide-y divide-slate-700">
								<thead class="bg-slate-900 sticky top-0">
									<tr>
										<th
											class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">
											IP</th>
										<th
											class="px-4 py-3 text-right text-xs font-medium text-gray-400 uppercase tracking-wider">
											Conns</th>
										<th
											class="px-4 py-3 text-right text-xs font-medium text-gray-400 uppercase tracking-wider">
											Traffic</th>
										<th
											class="px-4 py-3 text-right text-xs font-medium text-gray-400 uppercase tracking-wider">
											Avg Session</th>
									</tr>
								</thead>
								<tbody id="countryDetailIPTable" class="divide-y divide-slate-800">
									<tr>
										<td colspan="4" class="px-4 py-3 text-center text-xs text-slate-500">No
											country selected.</td>
									</tr>
								</tbody>
							</table>
						</div>
					</div>
				</div>
			</div>
			<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
				<div class="bg-slate-800 rounded-lg shadow-xl p-6 border border-slate-700">
					<h3 class="text-lg font-semibold text-white mb-4">Top Countries by Traffic</h3>
					<div style="position:relative;height:250px"><canvas id="countriesChart"></canvas></div>
				</div>
				<div class="bg-slate-800 rounded-lg shadow-xl p-6 border border-slate-700">
					<h3 class="text-lg font-semibold text-white mb-4">Top Ports by Connections</h3>
					<div style="position:relative;height:250px"><canvas id="portsChart"></canvas></div>
				</div>
			</div>
			<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
				<div class="bg-slate-800 rounded-lg shadow-xl border border-slate-700">
					<div class="px-6 py-4 border-b border-slate-700">
						<h3 class="text-lg font-semibold text-white">Top Talkers</h3>
						<p class="text-sm text-gray-400">IPs with highest traffic volume</p>
					</div>
					<div class="table-container">
						<table class="min-w-full divide-y divide-slate-700">
							<thead class="bg-slate-900 sticky top-0">
								<tr>
									<th
										class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">
										IP Address</th>
									<th
										class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">
										Country</th>
									<th
										class="px-6 py-3 text-right text-xs font-medium text-gray-400 uppercase tracking-wider">
										Traffic</th>
									<th
										class="px-6 py-3 text-right text-xs font-medium text-gray-400 uppercase tracking-wider">
										Conns</th>
								</tr>
							</thead>
							<tbody id="topTalkersTable" class="divide-y divide-slate-700"></tbody>
						</table>
					</div>
				</div>
				<div class="bg-slate-800 rounded-lg shadow-xl border border-slate-700">
					<div class="px-6 py-4 border-b border-slate-700">
						<h3 class="text-lg font-semibold text-white">Traffic by Protocol</h3>
						<p class="text-sm text-gray-400">Protocol distribution</p>
					</div>
					<div class="table-container">
						<table class="min-w-full divide-y divide-slate-700">
							<thead class="bg-slate-900 sticky top-0">
								<tr>
									<th
										class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">
										Protocol</th>
									<th
										class="px-6 py-3 text-right text-xs font-medium text-gray-400 uppercase tracking-wider">
										Connections</th>
									<th
										class="px-6 py-3 text-right text-xs font-medium text-gray-400 uppercase tracking-wider">
										Unique IPs</th>
									<th
										class="px-6 py-3 text-right text-xs font-medium text-gray-400 uppercase tracking-wider">
										Total Traffic</th>
								</tr>
							</thead>
							<tbody id="protocolTable" class="divide-y divide-slate-700"></tbody>
						</table>
					</div>
				</div>
			</div>
			<div class="bg-slate-800 rounded-lg shadow-xl border border-slate-700">
				<div class="px-6 py-4 border-b border-slate-700">
					<h3 class="text-lg font-semibold text-white">Upstream Servers</h3>
					<p class="text-xs text-slate-400 font-mono">Select a host to inspect IP stats.</p>
				</div>
				<div class="table-container">
					<table class="min-w-full divide-y divide-slate-700">
						<thead class="bg-slate-900 sticky top-0">
							<tr>
								<th
									class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">
									Server</th>
								<th
									class="px-6 py-3 text-right text-xs font-medium text-gray-400 uppercase tracking-wider">
									Connections</th>
								<th
									class="px-6 py-3 text-right text-xs font-medium text-gray-400 uppercase tracking-wider">
									Unique IPs</th>
								<th
									class="px-6 py-3 text-right text-xs font-medium text-gray-400 uppercase tracking-wider">
									Traffic</th>
								<th
									class="px-6 py-3 text-right text-xs font-medium text-gray-400 uppercase tracking-wider">
									Avg Session</th>
								<th
									class="px-6 py-3 text-right text-xs font-medium text-gray-400 uppercase tracking-wider">
									Failed</th>
							</tr>
						</thead>
						<tbody id="upstreamTable" class="divide-y divide-slate-700"></tbody>
					</table>
				</div>
			</div>
		</div>
	</main>

	<!-- Server Details Modal -->
	<div id="serverModal" class="modal">
		<div class="modal-content">
			<div class="modal-header flex justify-between items-start gap-6">
				<div>
					<p class="nerd-chip">Upstream / detail</p>
					<h2 id="modalServerName" class="font-semibold mt-2">-</h2>
					<p class="text-xs text-slate-400 mt-2">IP breakdown pulled directly from stream-proxy log.</p>
				</div>
				<button onclick="closeServerModal()" class="modal-close">ESC</button>
			</div>
			<div class="modal-body">
				<div class="modal-metrics">
					<div class="modal-metric">
						<label>Total IPs</label>
						<span id="modalTotalIPs">-</span>
					</div>
					<div class="modal-metric">
						<label>Connections</label>
						<span id="modalTotalConnections">-</span>
					</div>
					<div class="modal-metric">
						<label>Traffic</label>
						<span id="modalTotalTraffic">-</span>
					</div>
				</div>
				<div class="table-container modal-table">
					<table class="min-w-full divide-y divide-slate-700">
						<thead class="sticky top-0 bg-slate-900">
							<tr>
								<th
									class="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase tracking-[0.2em]">
									IP</th>
								<th
									class="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase tracking-[0.2em]">
									Country</th>
								<th
									class="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase tracking-[0.2em]">
									Connections</th>
								<th
									class="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase tracking-[0.2em]">
									Traffic</th>
							</tr>
						</thead>
						<tbody id="modalIPTable" class="divide-y divide-slate-800">
						</tbody>
					</table>
				</div>
			</div>
		</div>
	</div>

	<script>
		let charts = {};
		let isLoadingData = false;
		let hasLoadedOnce = false;
		let worldGeoDataPromise = null;
		let geoMapSvg = null;
		let geoMapGroup = null;
		let geoMapZoom = null;
		let countryDetailState = { name: null, controller: null };
		let serverActivityState = { selected: null, controller: null, loadingServer: null };
		Chart.defaults.color = '#9ca3af';
		Chart.defaults.borderColor = '#374151';
		function formatBytes(b) { if (b === 0) return '0 B'; const k = 1024, s = ['B', 'KB', 'MB', 'GB', 'TB'], i = Math.floor(Math.log(b) / Math.log(k)); return parseFloat((b / Math.pow(k, i)).toFixed(2)) + ' ' + s[i] }
		function formatTime(t) { return new Date(t).toLocaleString() }
		function formatTimestamp(ts) { const d = new Date(ts); return isNaN(d.getTime()) ? ts : d.toLocaleString() }
		function formatCompactTimestamp(ts) { const d = new Date(ts); if (isNaN(d.getTime())) return ts; return d.toLocaleString(undefined, { month: 'short', day: 'numeric', hour: '2-digit' }) }
		function formatSeconds(v) { return (typeof v === 'number' && isFinite(v)) ? v.toFixed(2) + 's' : '0.00s' }
		function loadWorldGeoData() {
			if (!worldGeoDataPromise) {
				worldGeoDataPromise = fetch('https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json')
					.then(r => r.json())
					.then(world => topojson.feature(world, world.objects.countries))
					.catch(err => {
						console.error('Failed to load world map data', err);
						worldGeoDataPromise = null;
						throw err;
					});
			}
			return worldGeoDataPromise;
		}
		function destroyChart(n) { if (charts[n]) { charts[n].destroy(); charts[n] = null } }
		function getDateParams() { const start = document.getElementById('startDate').value; const end = document.getElementById('endDate').value; let params = []; if (start) params.push('start=' + start); if (end) params.push('end=' + end); return params.length > 0 ? '?' + params.join('&') : '' }
		async function loadData(options = {}) {
			if (isLoadingData) return;
			isLoadingData = true;

			const { silent = hasLoadedOnce } = options;
			const loadingEl = document.getElementById('loading');
			const dashboardEl = document.getElementById('dashboard');
			const lastUpdateEl = document.getElementById('lastUpdate');
			const showFullLoader = !silent;

			if (showFullLoader) {
				loadingEl.classList.remove('hidden');
				dashboardEl.classList.add('hidden');
			} else if (lastUpdateEl) {
				lastUpdateEl.textContent = 'Refreshing data…';
			}

			try {
				const params = getDateParams();
				const flowParams = params ? (params + '&limit=50') : '?limit=50';
				const [dateInfo, summary, flow, daily, hourly, topCountries, topPorts, topTalkers, protocol, upstream, timeline, anomalies, countryHeat] = await Promise.all([
					fetch('/streamInfo/daterange' + params).then(r => r.json()),
					fetch('/streamInfo/summary' + params).then(r => r.json()),
					fetch('/streamInfo/flow' + flowParams).then(r => r.json()),
					fetch('/streamInfo/stats/daily' + params).then(r => r.json()),
					fetch('/streamInfo/stats/hourly' + params).then(r => r.json()),
					fetch('/streamInfo/top/countries' + params).then(r => r.json()),
					fetch('/streamInfo/top/ports' + params).then(r => r.json()),
					fetch('/streamInfo/top/talkers' + params).then(r => r.json()),
					fetch('/streamInfo/traffic/by-protocol' + params).then(r => r.json()),
					fetch('/streamInfo/upstream' + params).then(r => r.json()),
					fetch('/streamInfo/timeline' + params).then(r => r.json()),
					fetch('/streamInfo/anomalies' + params).then(r => r.json()),
					fetch('/streamInfo/traffic/by-country' + params).then(r => r.json())
				]);

				const renderCharts = () => {
					if (showFullLoader) {
						loadingEl.classList.add('hidden');
						dashboardEl.classList.remove('hidden');
					}
					updateDateInfo(dateInfo);
					updateSummaryCards(summary);
					updateSankeyChart(flow);
					updateDailyChart(daily);
					updateHourlyChart(hourly);
					updateCountriesChart(topCountries);
					updatePortsChart(topPorts);
					updateTopTalkersTable(topTalkers);
					updateProtocolTable(protocol);
					updateUpstreamTable(upstream);
					updateTimelineChart(timeline);
					updateAnomalyPanel(anomalies);
					updateFailureHotspots(timeline);
					updateBurstDetector(timeline);
					updateGeoHeatMap(countryHeat);
					updateServerActivityOptions(upstream);
					hasLoadedOnce = true;
					if (lastUpdateEl) {
						lastUpdateEl.textContent = 'Last updated: ' + new Date().toLocaleTimeString();
					}
				};

				if (typeof requestAnimationFrame === 'function') {
					requestAnimationFrame(renderCharts);
				} else {
					setTimeout(renderCharts, 0);
				}
			} catch (e) {
				console.error('Error loading data:', e);
				if (showFullLoader) {
					alert('Failed to load data. Please try again.');
				} else if (lastUpdateEl) {
					lastUpdateEl.textContent = 'Refresh failed at ' + new Date().toLocaleTimeString();
				}
			} finally {
				if (showFullLoader) {
					loadingEl.classList.add('hidden');
					dashboardEl.classList.remove('hidden');
				}
				isLoadingData = false;
			}
		}
		function updateDateInfo(d) { document.getElementById('datasetDays').textContent = d.total_days || '-'; document.getElementById('datasetRange').textContent = (d.min_date && d.max_date) ? (d.min_date + ' to ' + d.max_date) : '-'; document.getElementById('datasetTotal').textContent = (d.total_entries || 0).toLocaleString() }
		function updateSummaryCards(d) { document.getElementById('totalConns').textContent = d.total_connections.toLocaleString(); document.getElementById('uniqueIPs').textContent = d.unique_ips.toLocaleString(); document.getElementById('uniqueCountries').textContent = d.unique_countries; document.getElementById('totalBytes').textContent = formatBytes(d.total_bytes); document.getElementById('avgSession').textContent = d.avg_session_time_seconds.toFixed(2); document.getElementById('failedConns').textContent = d.failed_connections.toLocaleString(); document.getElementById('dateRange').textContent = d.date_range; const sr = ((d.successful_connections / d.total_connections) * 100).toFixed(1); document.getElementById('successRate').textContent = sr + '%' }
		function updateSankeyChart(data, attempt = 0) {
			const container = document.getElementById('sankeyChart');
			container.innerHTML = '';
			console.log('Sankey data:', data);
			if (!data || data.length === 0) {
				container.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:#9ca3af">No flow data available</div>';
				return
			}
			try {
				document.getElementById('flowCount').textContent = data.length;

				// Check if d3.sankey is available
				if (typeof d3.sankey !== 'function') {
					console.error('d3.sankey is not available!');
					// Fallback to simple bar chart visualization
					container.innerHTML = '<div style="padding:20px;color:#9ca3af;text-align:center">Loading Sankey library...</div>';
					setTimeout(() => updateSankeyChart(data), 1000);
					return;
				}

				const margin = { top: 20, right: 150, bottom: 20, left: 150 };
				let availableWidth = container.offsetWidth;

				if (availableWidth <= (margin.left + margin.right)) {
					if (attempt < 5) {
						const retry = () => updateSankeyChart(data, attempt + 1);
						if (typeof requestAnimationFrame === 'function') {
							requestAnimationFrame(retry);
						} else {
							setTimeout(retry, 50);
						}
						return;
					}

					const parentWidth = container.parentElement ? container.parentElement.offsetWidth : 0;
					const dashboardWidth = document.getElementById('dashboard') ? document.getElementById('dashboard').offsetWidth : 0;
					availableWidth = Math.max(parentWidth, dashboardWidth, window.innerWidth || 0, 600);
				}

				const width = Math.max(availableWidth - margin.left - margin.right, 200);
				const height = 600 - margin.top - margin.bottom;

				const svg = d3.select('#sankeyChart')
					.append('svg')
					.attr('width', width + margin.left + margin.right)
					.attr('height', height + margin.top + margin.bottom)
					.append('g')
					.attr('transform', `translate(${margin.left},${margin.top})`);

				// Build nodes and links
				const nodes = [];
				const nodeMap = new Map();

				data.forEach(d => {
					if (!nodeMap.has(d.source)) {
						nodeMap.set(d.source, nodes.length);
						nodes.push({ name: d.source });
					}
					if (!nodeMap.has(d.destination)) {
						nodeMap.set(d.destination, nodes.length);
						nodes.push({ name: d.destination });
					}
				});

				const links = data.map(d => ({
					source: nodeMap.get(d.source),
					target: nodeMap.get(d.destination),
					value: d.connections,
					bytes: d.total_bytes
				}));

				console.log('Creating sankey with nodes:', nodes.length, 'links:', links.length);

				// Create sankey generator
				const sankeyGenerator = d3.sankey()
					.nodeWidth(20)
					.nodePadding(20)
					.extent([[0, 0], [width, height]]);

				// Generate the sankey diagram
				const graph = sankeyGenerator({
					nodes: nodes.map(d => Object.assign({}, d)),
					links: links.map(d => Object.assign({}, d))
				});

				console.log('Sankey graph generated:', graph);

				// Color scale
				const color = d3.scaleOrdinal(d3.schemeCategory10);

				// Draw links
				const link = svg.append('g')
					.selectAll('.link')
					.data(graph.links)
					.join('path')
					.attr('class', 'link')
					.attr('d', d3.sankeyLinkHorizontal())
					.attr('stroke', d => color(graph.nodes[d.source.index].name))
					.attr('stroke-width', d => Math.max(1, d.width))
					.attr('fill', 'none')
					.attr('opacity', 0.5)
					.on('mouseover', function () {
						d3.select(this).attr('opacity', 0.8);
					})
					.on('mouseout', function () {
						d3.select(this).attr('opacity', 0.5);
					});

				// Add link titles
				link.append('title')
					.text(d => `${graph.nodes[d.source.index].name} → ${graph.nodes[d.target.index].name}\n${d.value} connections\n${formatBytes(d.bytes)}`);

				// Draw nodes
				const node = svg.append('g')
					.selectAll('.node')
					.data(graph.nodes)
					.join('g')
					.attr('class', 'node');

				node.append('rect')
					.attr('x', d => d.x0)
					.attr('y', d => d.y0)
					.attr('height', d => d.y1 - d.y0)
					.attr('width', d => d.x1 - d.x0)
					.attr('fill', d => color(d.name))
					.attr('opacity', 0.8)
					.attr('stroke', '#000')
					.attr('stroke-width', 1);

				node.append('title')
					.text(d => `${d.name}\n${d.value || 0} connections`);

				// Add node labels
				node.append('text')
					.attr('x', d => d.x0 < width / 2 ? d.x1 + 6 : d.x0 - 6)
					.attr('y', d => (d.y1 + d.y0) / 2)
					.attr('dy', '0.35em')
					.attr('text-anchor', d => d.x0 < width / 2 ? 'start' : 'end')
					.attr('fill', '#e5e7eb')
					.attr('font-size', '14px')
					.attr('font-weight', 'bold')
					.text(d => d.name);

				console.log('Sankey chart created successfully');
			} catch (e) {
				console.error('Sankey error:', e);
				container.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:#ef4444">Error: ' + e.message + '</div>';
			}
		}
		function updateDailyChart(d) {
			const labels = d.map(x => x.date);
			const connections = d.map(x => x.connections);
			const uniqueIPs = d.map(x => x.unique_ips);
			if (!charts.daily) {
				const ctx = document.getElementById('dailyChart').getContext('2d');
				charts.daily = new Chart(ctx, {
					type: 'line',
					data: {
						labels,
						datasets: [
							{ label: 'Connections', data: connections, borderColor: 'rgb(59,130,246)', backgroundColor: 'rgba(59,130,246,0.1)', tension: 0.4, fill: true },
							{ label: 'Unique IPs', data: uniqueIPs, borderColor: 'rgb(34,197,94)', backgroundColor: 'rgba(34,197,94,0.1)', tension: 0.4, fill: true }
						]
					},
					options: { responsive: true, maintainAspectRatio: false, animation: { duration: 700 }, plugins: { legend: { position: 'top', labels: { color: '#e5e7eb' } } }, scales: { y: { beginAtZero: true, ticks: { color: '#9ca3af' }, grid: { color: '#374151' } }, x: { ticks: { color: '#9ca3af' }, grid: { color: '#374151' } } } }
				});
			} else {
				const chart = charts.daily;
				chart.data.labels = labels;
				chart.data.datasets[0].data = connections;
				chart.data.datasets[1].data = uniqueIPs;
				chart.update();
			}
		}
		function updateHourlyChart(d) {
			const labels = d.map(x => x.hour + ':00');
			const connections = d.map(x => x.connections);
			if (!charts.hourly) {
				const ctx = document.getElementById('hourlyChart').getContext('2d');
				charts.hourly = new Chart(ctx, {
					type: 'bar',
					data: { labels, datasets: [{ label: 'Connections', data: connections, backgroundColor: 'rgba(147,51,234,0.6)', borderColor: 'rgb(147,51,234)', borderWidth: 1 }] },
					options: { responsive: true, maintainAspectRatio: false, animation: { duration: 700 }, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { color: '#9ca3af' }, grid: { color: '#374151' } }, x: { ticks: { color: '#9ca3af' }, grid: { color: '#374151' } } } }
				});
			} else {
				const chart = charts.hourly;
				chart.data.labels = labels;
				chart.data.datasets[0].data = connections;
				chart.update();
			}
		}
		function updateCountriesChart(d) {
			const labels = d.map(x => x.country);
			const totals = d.map(x => x.total_bytes);
			if (!charts.countries) {
				const ctx = document.getElementById('countriesChart').getContext('2d');
				charts.countries = new Chart(ctx, {
					type: 'doughnut',
					data: { labels, datasets: [{ data: totals, backgroundColor: ['rgba(59,130,246,0.8)', 'rgba(34,197,94,0.8)', 'rgba(251,146,60,0.8)', 'rgba(239,68,68,0.8)', 'rgba(147,51,234,0.8)', 'rgba(236,72,153,0.8)', 'rgba(14,165,233,0.8)', 'rgba(132,204,22,0.8)', 'rgba(250,204,21,0.8)', 'rgba(168,85,247,0.8)'], borderColor: '#1e293b', borderWidth: 2 }] },
					options: { responsive: true, maintainAspectRatio: false, animation: { duration: 700 }, plugins: { legend: { position: 'right', labels: { color: '#e5e7eb', padding: 10 } }, tooltip: { callbacks: { label: function (c) { return c.label + ': ' + formatBytes(c.parsed) } } } } }
				});
			} else {
				const chart = charts.countries;
				chart.data.labels = labels;
				chart.data.datasets[0].data = totals;
				chart.update();
			}
		}
		function updatePortsChart(d) {
			const labels = d.map(x => 'Port ' + x.port);
			const connections = d.map(x => x.connections);
			if (!charts.ports) {
				const ctx = document.getElementById('portsChart').getContext('2d');
				charts.ports = new Chart(ctx, {
					type: 'bar',
					data: { labels, datasets: [{ label: 'Connections', data: connections, backgroundColor: 'rgba(34,197,94,0.6)', borderColor: 'rgb(34,197,94)', borderWidth: 1 }] },
					options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', animation: { duration: 700 }, plugins: { legend: { display: false } }, scales: { x: { beginAtZero: true, ticks: { color: '#9ca3af' }, grid: { color: '#374151' } }, y: { ticks: { color: '#9ca3af' }, grid: { color: '#374151' } } } }
				});
			} else {
				const chart = charts.ports;
				chart.data.labels = labels;
				chart.data.datasets[0].data = connections;
				chart.update();
			}
		}
		async function updateGeoHeatMap(countryData) {
			const container = document.getElementById('geoMap');
			const statusEl = document.getElementById('geoMapStatus');
			const summaryEl = document.getElementById('geoMapSummary');
			if (!container) return;

			const resetStatus = (text) => {
				if (statusEl) {
					statusEl.textContent = text || '';
					statusEl.style.display = text ? 'block' : 'none';
				}
			};

			if (!Array.isArray(countryData) || countryData.length === 0) {
				if (summaryEl) summaryEl.textContent = 'No data';
				container.querySelectorAll('svg').forEach(el => el.remove());
				container.querySelectorAll('.geo-map-legend').forEach(el => el.remove());
				geoMapSvg = null;
				geoMapGroup = null;
				resetStatus('No country data');
				return;
			}

			try {
				const geojson = await loadWorldGeoData();
				const metrics = {};
				let totalBytes = 0;
				countryData.forEach(item => {
					const key = (item.country || 'Unknown').toLowerCase();
					const bytes = (item.total_bytes) || ((item.bytes_sent || 0) + (item.bytes_received || 0));
					metrics[key] = (metrics[key] || 0) + bytes;
					totalBytes += bytes;
				});

				const values = Object.values(metrics);
				const maxValue = values.length ? Math.max(...values) : 0;
				const colorScale = d3.scaleSequential(d3.interpolateYlOrRd).domain([0, maxValue || 1]);
				const width = container.clientWidth || 800;
				const height = container.clientHeight || 500;

				container.querySelectorAll('svg').forEach(el => el.remove());
				container.querySelectorAll('.geo-map-legend').forEach(el => el.remove());
				container.querySelectorAll('.geo-map-controls').forEach(el => el.remove());

				geoMapSvg = d3.select(container)
					.append('svg')
					.attr('width', width)
					.attr('height', height);

				// Create globe projection
				const projection = d3.geoOrthographic()
					.scale(Math.min(width, height) / 2.2)
					.translate([width / 2, height / 2])
					.clipAngle(90);

				const path = d3.geoPath().projection(projection);

				// Add sphere (ocean background)
				geoMapSvg.append('path')
					.datum({ type: 'Sphere' })
					.attr('class', 'sphere')
					.attr('d', path)
					.attr('fill', 'url(#oceanGradient)')
					.attr('stroke', 'rgba(59, 130, 246, 0.4)')
					.attr('stroke-width', 2);

				// Add ocean gradient
				const defs = geoMapSvg.append('defs');
				const gradient = defs.append('radialGradient')
					.attr('id', 'oceanGradient');
				gradient.append('stop')
					.attr('offset', '0%')
					.attr('stop-color', '#1e3a5f');
				gradient.append('stop')
					.attr('offset', '100%')
					.attr('stop-color', '#0a1929');

				// Add graticule (grid lines)
				const graticule = d3.geoGraticule();
				geoMapSvg.append('path')
					.datum(graticule)
					.attr('class', 'graticule')
					.attr('d', path)
					.attr('fill', 'none')
					.attr('stroke', 'rgba(148, 163, 184, 0.15)')
					.attr('stroke-width', 0.5);

				geoMapGroup = geoMapSvg.append('g').attr('class', 'map-layer');

				// Add countries
				const countries = geoMapGroup.selectAll('path.country')
					.data(geojson.features)
					.join('path')
					.attr('class', 'country')
					.attr('d', path)
					.attr('fill', d => {
						const name = ((d.properties && d.properties.name) || '').toLowerCase();
						const value = metrics[name] || 0;
						return value > 0 ? colorScale(value) : '#1e293b';
					})
					.attr('stroke', 'rgba(148, 163, 184, 0.3)')
					.attr('stroke-width', 0.5)
					.on('click', (event, d) => {
						event.stopPropagation();
						const name = d.properties && d.properties.name ? d.properties.name : 'Unknown';
						loadCountryDetail(name);
					})
					.on('mouseenter', function (event, d) {
						const name = d.properties && d.properties.name ? d.properties.name : 'Unknown';
						const value = metrics[(name || '').toLowerCase()] || 0;
						d3.select(this).attr('stroke-width', 1.5);
						showGlobeTooltip(event, name + ': ' + formatBytes(value));
					})
					.on('mouseleave', function () {
						d3.select(this).attr('stroke-width', 0.5);
						hideGlobeTooltip();
					});

				// Add drag rotation
				let rotation = { x: 0, y: 0 };
				const drag = d3.drag()
					.on('start', function (event) {
						rotation.x = event.x;
						rotation.y = event.y;
					})
					.on('drag', function (event) {
						const rotate = projection.rotate();
						const k = 75 / projection.scale();
						projection.rotate([
							rotate[0] + (event.x - rotation.x) * k,
							rotate[1] - (event.y - rotation.y) * k
						]);
						rotation.x = event.x;
						rotation.y = event.y;

						geoMapSvg.selectAll('path').attr('d', path);
					});

				geoMapSvg.call(drag);

				// Add mouse wheel zoom
				geoMapSvg.on('wheel', function (event) {
					event.preventDefault();
					const currentScale = projection.scale();
					const minScale = Math.min(width, height) / 2.2;
					const maxScale = minScale * 4;
					const delta = event.deltaY > 0 ? 0.9 : 1.1;
					const newScale = Math.max(minScale, Math.min(maxScale, currentScale * delta));

					projection.scale(newScale);
					geoMapSvg.selectAll('path').attr('d', path);
				});

				// Add control buttons
				const controls = document.createElement('div');
				controls.className = 'geo-map-controls';
				controls.innerHTML = `
					<button onclick="rotateGlobe(-15, 0)" title="Rotate Left">←</button>
					<button onclick="rotateGlobe(15, 0)" title="Rotate Right">→</button>
					<button onclick="rotateGlobe(0, 15)" title="Rotate Up">↑</button>
					<button onclick="rotateGlobe(0, -15)" title="Rotate Down">↓</button>
					<button onclick="zoomGlobe(1.2)" title="Zoom In">+</button>
					<button onclick="zoomGlobe(0.8)" title="Zoom Out">−</button>
					<button onclick="resetGlobe()" title="Reset View">⟲</button>
				`;
				container.appendChild(controls);

				// Store projection and dimensions for controls
				window.globeProjection = projection;
				window.globePath = path;
				window.globeContainer = { width, height };

				const legend = document.createElement('div');
				legend.className = 'geo-map-legend';
				legend.innerHTML = '<div>traffic</div><div style="height:6px;border-radius:999px;margin:6px 0;background:linear-gradient(90deg,#0ea5e9,#f97316,#dc2626);"></div><div style="display:flex;justify-content:space-between;font-size:0.6rem;text-transform:none;letter-spacing:0;"><span>low</span><span>' + formatBytes(maxValue || 0) + '</span></div>';
				container.appendChild(legend);

				if (summaryEl) {
					summaryEl.textContent = formatBytes(totalBytes) + ' total';
				}
				resetStatus('');
				highlightCountry(countryDetailState.name);
			} catch (error) {
				console.error('Heat map render failed:', error);
				if (summaryEl) summaryEl.textContent = 'Error';
				resetStatus('Map unavailable');
			}
		}
		function rotateGlobe(deltaLon, deltaLat) {
			if (!window.globeProjection || !window.globePath) return;
			const rotate = window.globeProjection.rotate();
			window.globeProjection.rotate([rotate[0] + deltaLon, rotate[1] + deltaLat]);
			if (geoMapSvg) {
				geoMapSvg.selectAll('path').attr('d', window.globePath);
			}
		}

		function zoomGlobe(factor) {
			if (!window.globeProjection || !window.globePath || !window.globeContainer) return;

			const currentScale = window.globeProjection.scale();
			const { width, height } = window.globeContainer;
			const minScale = Math.min(width, height) / 2.2;
			const maxScale = minScale * 4;
			const newScale = Math.max(minScale, Math.min(maxScale, currentScale * factor));

			window.globeProjection.scale(newScale);
			if (geoMapSvg) {
				geoMapSvg.selectAll('path').attr('d', window.globePath);
			}
		}

		function resetGlobe() {
			if (!window.globeProjection || !window.globePath || !window.globeContainer) return;
			const { width, height } = window.globeContainer;
			const defaultScale = Math.min(width, height) / 2.2;

			window.globeProjection.rotate([0, 0]);
			window.globeProjection.scale(defaultScale);
			if (geoMapSvg) {
				geoMapSvg.selectAll('path').attr('d', window.globePath);
			}
		}

		function showGlobeTooltip(event, text) {
			let tooltip = document.querySelector('.geo-map-tooltip');
			if (!tooltip) {
				tooltip = document.createElement('div');
				tooltip.className = 'geo-map-tooltip';
				document.body.appendChild(tooltip);
			}
			tooltip.textContent = text;
			tooltip.style.display = 'block';
			tooltip.style.left = (event.pageX + 10) + 'px';
			tooltip.style.top = (event.pageY + 10) + 'px';
		}

		function hideGlobeTooltip() {
			const tooltip = document.querySelector('.geo-map-tooltip');
			if (tooltip) {
				tooltip.style.display = 'none';
			}
		}

		function abortCountryDetailFetch() {
			if (countryDetailState.controller) {
				countryDetailState.controller.abort();
				countryDetailState.controller = null;
			}
		}
		function highlightCountry(country) {
			if (!geoMapGroup) return;
			const normalized = country ? country.toLowerCase() : null;
			geoMapGroup.selectAll('path.country')
				.classed('selected', d => {
					if (!normalized) {
						return false;
					}
					const name = d.properties && d.properties.name ? d.properties.name.toLowerCase() : '';
					return name === normalized;
				});
		}
		function clearCountryDetail(message = 'Click the map to load details.') {
			abortCountryDetailFetch();
			const nameEl = document.getElementById('countryDetailName');
			const metaEl = document.getElementById('countryDetailMeta');
			const statsEl = document.getElementById('countryDetailStats');
			const tableEl = document.getElementById('countryDetailIPTable');
			if (nameEl) nameEl.textContent = 'Select a country';
			if (metaEl) metaEl.textContent = message;
			if (statsEl) statsEl.classList.add('hidden');
			if (tableEl) tableEl.innerHTML = '<tr><td colspan="4" class="px-4 py-3 text-center text-xs text-slate-500">No country selected.</td></tr>';
			countryDetailState.name = null;
			highlightCountry(null);
		}
		function setCountryDetailLoading(name) {
			const nameEl = document.getElementById('countryDetailName');
			const metaEl = document.getElementById('countryDetailMeta');
			const statsEl = document.getElementById('countryDetailStats');
			const tableEl = document.getElementById('countryDetailIPTable');
			if (nameEl) nameEl.textContent = name;
			if (metaEl) metaEl.textContent = 'Loading telemetry…';
			if (statsEl) statsEl.classList.add('hidden');
			if (tableEl) tableEl.innerHTML = '<tr><td colspan="4" class="px-4 py-3 text-center text-xs text-slate-500">Loading…</td></tr>';
			highlightCountry(name);
		}
		function setCountryDetailError(name, message) {
			const metaEl = document.getElementById('countryDetailMeta');
			const tableEl = document.getElementById('countryDetailIPTable');
			if (metaEl) metaEl.textContent = message;
			if (tableEl) tableEl.innerHTML = '<tr><td colspan="4" class="px-4 py-3 text-center text-xs text-red-400">' + message + '</td></tr>';
			const statsEl = document.getElementById('countryDetailStats');
			if (statsEl) statsEl.classList.add('hidden');
			countryDetailState.name = name || null;
			highlightCountry(name);
		}
		function renderCountryDetail(data) {
			const nameEl = document.getElementById('countryDetailName');
			const metaEl = document.getElementById('countryDetailMeta');
			const statsEl = document.getElementById('countryDetailStats');
			const tableEl = document.getElementById('countryDetailIPTable');
			if (!data || !nameEl || !metaEl || !statsEl || !tableEl) {
				return;
			}
			countryDetailState.name = data.country;
			nameEl.textContent = data.country || 'Unknown';
			metaEl.textContent = (data.connections || 0).toLocaleString() + ' connections · ' + (data.unique_upstreams || 0) + ' upstreams';
			statsEl.classList.remove('hidden');
			document.getElementById('countryDetailUniqueIPs').textContent = (data.unique_ips || 0).toLocaleString();
			document.getElementById('countryDetailBytes').textContent = formatBytes(data.total_bytes || 0);
			document.getElementById('countryDetailAvg').textContent = formatSeconds(data.avg_session_time_seconds || 0);
			document.getElementById('countryDetailMedian').textContent = formatSeconds(data.median_session_time_seconds || 0);
			if (!data.top_ips || data.top_ips.length === 0) {
				tableEl.innerHTML = '<tr><td colspan="4" class="px-4 py-3 text-center text-xs text-slate-500">No IP data available.</td></tr>';
			} else {
				tableEl.innerHTML = data.top_ips.map(ip => '<tr class="table-row">' +
					'<td class="px-4 py-3 text-sm font-mono text-slate-200">' + ip.ip + '</td>' +
					'<td class="px-4 py-3 text-sm text-right text-slate-200">' + (ip.connections || 0).toLocaleString() + '</td>' +
					'<td class="px-4 py-3 text-sm text-right text-slate-200">' + formatBytes(ip.total_bytes || 0) + '</td>' +
					'<td class="px-4 py-3 text-sm text-right text-slate-400">' + formatSeconds(ip.avg_session_seconds || 0) + '</td>' +
					'</tr>').join('');
			}
			highlightCountry(data.country);
		}
		async function loadCountryDetail(country) {
			if (!country || country.toLowerCase() === 'unknown') {
				clearCountryDetail('No telemetry for that region.');
				return;
			}
			abortCountryDetailFetch();
			setCountryDetailLoading(country);
			try {
				const controller = new AbortController();
				countryDetailState.controller = controller;
				const params = getDateParams();
				const response = await fetch('/streamInfo/country/' + encodeURIComponent(country) + (params || ''), { signal: controller.signal });
				if (!response.ok) {
					throw new Error('Failed to load country detail');
				}
				const data = await response.json();
				if (controller.signal.aborted) return;
				countryDetailState.controller = null;
				renderCountryDetail(data);
			} catch (error) {
				if (error.name === 'AbortError') return;
				countryDetailState.controller = null;
				console.error('Country detail error:', error);
				setCountryDetailError(country, 'No telemetry available.');
			}
		}
		function updateTimelineChart(d) {
			const summaryEl = document.getElementById('timelineSummary');
			if (!Array.isArray(d) || d.length === 0) {
				if (summaryEl) {
					summaryEl.textContent = 'No timeline data in selected window.';
				}
				if (charts.timeline) {
					charts.timeline.destroy();
					charts.timeline = null;
				}
				return;
			}
			const labels = d.map(point => formatCompactTimestamp(point.timestamp));
			const connections = d.map(point => point.connections);
			const failureRate = d.map(point => (point.failure_rate || 0) * 100);
			const latest = d[d.length - 1];
			if (summaryEl) {
				const failText = ((latest.failure_rate || 0) * 100).toFixed(1) + '% fail';
				summaryEl.textContent = formatTimestamp(latest.timestamp) + ' · ' + latest.connections.toLocaleString() + ' conns · ' + failText;
			}
			if (!charts.timeline) {
				const ctx = document.getElementById('timelineChart').getContext('2d');
				charts.timeline = new Chart(ctx, {
					type: 'bar',
					data: {
						labels,
						datasets: [
							{
								type: 'bar',
								label: 'Connections',
								data: connections,
								backgroundColor: 'rgba(14,165,233,0.35)',
								borderColor: 'rgba(14,165,233,0.9)',
								borderWidth: 1,
								yAxisID: 'y'
							},
							{
								type: 'line',
								label: 'Failure %',
								data: failureRate,
								borderColor: 'rgba(248,113,113,1)',
								backgroundColor: 'rgba(248,113,113,0.15)',
								yAxisID: 'y1',
								tension: 0.35,
								pointRadius: 2,
								pointHoverRadius: 4,
								fill: false
							}
						]
					},
					options: {
						responsive: true,
						maintainAspectRatio: false,
						interaction: { mode: 'index', intersect: false },
						scales: {
							x: {
								ticks: { maxRotation: 0, color: '#94a3b8' },
								grid: { color: '#1f2937' }
							},
							y: {
								beginAtZero: true,
								position: 'left',
								grid: { color: '#1f2937' },
								ticks: {
									color: '#94a3b8',
									callback: value => Number(value).toLocaleString()
								}
							},
							y1: {
								beginAtZero: true,
								position: 'right',
								grid: { display: false },
								ticks: {
									color: '#fca5a5',
									callback: value => value + '%'
								}
							}
						},
						plugins: {
							legend: { labels: { color: '#cbd5f5' } },
							tooltip: {
								callbacks: {
									label: context => {
										const label = context.dataset.label || '';
										const value = context.parsed.y !== undefined ? context.parsed.y : context.parsed;
										if (context.dataset.label === 'Failure %') {
											return label + ': ' + Number(value).toFixed(2) + '%';
										}
										return label + ': ' + Number(value).toLocaleString();
									}
								}
							}
						}
					}
				});
			} else {
				const chart = charts.timeline;
				chart.data.labels = labels;
				chart.data.datasets[0].data = connections;
				chart.data.datasets[1].data = failureRate;
				chart.update();
			}
		}
		function updateAnomalyPanel(events) {
			const container = document.getElementById('anomalyList');
			const badge = document.getElementById('anomalyCount');
			if (!container) return;
			if (!Array.isArray(events) || events.length === 0) {
				if (badge) {
					badge.textContent = 'No signals';
				}
				container.innerHTML = '<div class="p-4 text-xs text-slate-500 font-mono">Timeline looks steady.</div>';
				return;
			}
			if (badge) {
				badge.textContent = events.length + ' signals';
			}
			container.innerHTML = events.map(event => {
				const ts = formatTimestamp(event.timestamp);
				const failPct = ((event.failure_rate || 0) * 100).toFixed(1);
				const bytes = formatBytes(event.total_bytes || 0);
				const signals = (event.signals && event.signals.length ? event.signals : ['Anomaly detected']).map(signal => '<li>' + signal + '</li>').join('');
				return '<div class="border border-slate-700 rounded-lg p-3 bg-slate-900/40">' +
					'<div class="flex justify-between text-[0.65rem] uppercase tracking-[0.2em] text-slate-500"><span>' + ts + '</span><span>score ' + (event.score || 0).toFixed(2) + '</span></div>' +
					'<p class="text-sm text-slate-200 mt-2">' + Number(event.connections || 0).toLocaleString() + ' conns · ' + failPct + '% fail · ' + bytes + '</p>' +
					'<ul class="list-disc ml-4 mt-2 text-xs text-slate-400 space-y-1">' + signals + '</ul>' +
					'</div>';
			}).join('');
		}
		function setServerActivityStatus(text) {
			const statusEl = document.getElementById('serverActivityStatus');
			if (statusEl) statusEl.textContent = text;
		}
		function destroyServerActivityCharts() {
			if (charts.serverDaily) {
				charts.serverDaily.destroy();
				charts.serverDaily = null;
			}
			if (charts.serverHourly) {
				charts.serverHourly.destroy();
				charts.serverHourly = null;
			}
		}
		function updateServerActivityOptions(upstreams) {
			const select = document.getElementById('serverActivitySelect');
			if (!select) return;
			const previous = serverActivityState.selected;
			if (!Array.isArray(upstreams) || upstreams.length === 0) {
				select.innerHTML = '<option value="">No upstreams</option>';
				serverActivityState.selected = null;
				setServerActivityStatus('No upstream telemetry available.');
				destroyServerActivityCharts();
				return;
			}
			select.innerHTML = upstreams.map(item => {
				const value = item.upstream_addr || '';
				return '<option value="' + value + '">' + value + '</option>';
			}).join('');
			if (previous && upstreams.some(item => item.upstream_addr === previous)) {
				serverActivityState.selected = previous;
			} else {
				serverActivityState.selected = upstreams[0].upstream_addr;
			}
			select.value = serverActivityState.selected || '';

			// Auto-load activity for selected server
			if (serverActivityState.selected) {
				refreshServerActivity(false);
			}
		}
		function handleServerActivityChange(value) {
			serverActivityState.selected = value || null;
			refreshServerActivity(true);
		}
		function refreshServerActivity(force = false) {
			const server = serverActivityState.selected;
			if (!server) {
				setServerActivityStatus('Select a server.');
				destroyServerActivityCharts();
				return;
			}
			loadServerActivity(server, { force });
		}
		function loadServerActivity(server, options = {}) {
			const { force = false } = options;
			if (!server || server.trim() === '') {
				setServerActivityStatus('No server selected.');
				destroyServerActivityCharts();
				return;
			}
			if (!force && serverActivityState.loadingServer === server) {
				return;
			}
			if (serverActivityState.controller) {
				serverActivityState.controller.abort();
			}
			serverActivityState.loadingServer = server;
			const controller = new AbortController();
			serverActivityState.controller = controller;
			setServerActivityStatus('Loading telemetry for ' + server + ' …');
			const params = getDateParams();
			const url = '/streamInfo/server/' + encodeURIComponent(server) + '/activity' + (params || '');
			console.log('Fetching server activity:', url);
			fetch(url, { signal: controller.signal })
				.then(response => {
					if (!response.ok) {
						if (response.status === 404) {
							return response.json().then(err => {
								throw new Error(err.error || 'No data found for this server');
							}).catch(() => {
								throw new Error('No data found for this server');
							});
						}
						throw new Error('Failed to load server activity (HTTP ' + response.status + ')');
					}
					return response.json();
				})
				.then(data => {
					if (controller.signal.aborted) return;
					serverActivityState.controller = null;
					serverActivityState.loadingServer = null;
					renderServerActivityCharts(data);
				})
				.catch(error => {
					if (error.name === 'AbortError') return;
					console.error('Server activity error:', error);
					serverActivityState.controller = null;
					serverActivityState.loadingServer = null;
					setServerActivityStatus(error.message || 'Unable to load server telemetry.');
					destroyServerActivityCharts();
				});
		}
		function renderServerActivityCharts(data) {
			if (!data || (!Array.isArray(data.daily) && !Array.isArray(data.hourly))) {
				setServerActivityStatus('No data returned for this server.');
				destroyServerActivityCharts();
				return;
			}
			const server = data.upstream || serverActivityState.selected || 'server';
			const statusText = 'Server ' + server + ': ' + (Array.isArray(data.daily) ? data.daily.length : 0) + ' days';
			setServerActivityStatus(statusText);
			const dailyLabels = (data.daily || []).map(item => item.date);
			const dailyConnections = (data.daily || []).map(item => item.connections);
			if (!charts.serverDaily) {
				const ctx = document.getElementById('serverDailyChart').getContext('2d');
				charts.serverDaily = new Chart(ctx, {
					type: 'line',
					data: {
						labels: dailyLabels,
						datasets: [{
							label: 'Connections',
							data: dailyConnections,
							borderColor: 'rgba(129, 140, 248, 0.9)',
							backgroundColor: 'rgba(129, 140, 248, 0.1)',
							tension: 0.35,
							fill: true
						}]
					},
					options: {
						responsive: true,
						maintainAspectRatio: false,
						scales: {
							x: { ticks: { color: '#94a3b8' }, grid: { color: '#1f2937' } },
							y: { beginAtZero: true, ticks: { color: '#94a3b8' }, grid: { color: '#1f2937' } }
						},
						plugins: { legend: { display: false } }
					}
				});
			} else {
				charts.serverDaily.data.labels = dailyLabels;
				charts.serverDaily.data.datasets[0].data = dailyConnections;
				charts.serverDaily.update();
			}
			const hourlyLabels = (data.hourly || []).map(item => item.hour + ':00');
			const hourlyConnections = (data.hourly || []).map(item => item.connections);
			if (!charts.serverHourly) {
				const ctx = document.getElementById('serverHourlyChart').getContext('2d');
				charts.serverHourly = new Chart(ctx, {
					type: 'bar',
					data: {
						labels: hourlyLabels,
						datasets: [{
							label: 'Connections',
							data: hourlyConnections,
							backgroundColor: 'rgba(14,165,233,0.5)',
							borderColor: 'rgba(14,165,233,0.9)',
							borderWidth: 1
						}]
					},
					options: {
						responsive: true,
						maintainAspectRatio: false,
						scales: {
							x: { ticks: { color: '#94a3b8', maxRotation: 0 }, grid: { color: '#1f2937' } },
							y: { beginAtZero: true, ticks: { color: '#94a3b8' }, grid: { color: '#1f2937' } }
						},
						plugins: { legend: { display: false } }
					}
				});
			} else {
				charts.serverHourly.data.labels = hourlyLabels;
				charts.serverHourly.data.datasets[0].data = hourlyConnections;
				charts.serverHourly.update();
			}
		}
		function updateFailureHotspots(points) {
			const table = document.getElementById('failureHotspotsTable');
			if (!table) return;
			if (!Array.isArray(points) || points.length === 0) {
				table.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-xs text-slate-500">No timeline data.</td></tr>';
				return;
			}
			const ranked = points
				.filter(p => (p.connections || 0) > 0)
				.map(p => ({
					ts: formatCompactTimestamp(p.timestamp),
					failRate: ((p.failure_rate || 0) * 100),
					connections: p.connections || 0,
					uniqueIPs: p.unique_ips || 0
				}))
				.sort((a, b) => b.failRate - a.failRate)
				.slice(0, 5);
			if (ranked.length === 0 || ranked[0].failRate === 0) {
				table.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-xs text-slate-500">Failure rates are quiet.</td></tr>';
				return;
			}
			table.innerHTML = ranked.map(row =>
				'<tr class="table-row">' +
				'<td class="px-6 py-3 text-sm text-slate-200">' + row.ts + '</td>' +
				'<td class="px-6 py-3 text-sm text-right text-slate-200">' + row.connections.toLocaleString() + '</td>' +
				'<td class="px-6 py-3 text-sm text-right text-amber-300 font-semibold">' + row.failRate.toFixed(1) + '%</td>' +
				'<td class="px-6 py-3 text-sm text-right text-slate-400">' + row.uniqueIPs + '</td>' +
				'</tr>'
			).join('');
		}
		function updateBurstDetector(points) {
			const table = document.getElementById('burstDetectorTable');
			if (!table) return;
			if (!Array.isArray(points) || points.length < 2) {
				table.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-xs text-slate-500">Need more timeline samples.</td></tr>';
				return;
			}
			const bursts = [];
			for (let i = 1; i < points.length; i++) {
				const prev = points[i - 1];
				const curr = points[i];
				const delta = (curr.connections || 0) - (prev.connections || 0);
				if (delta <= 0) continue;
				const pctChange = prev.connections > 0 ? (delta / prev.connections) * 100 : 100;
				bursts.push({
					ts: formatCompactTimestamp(curr.timestamp),
					delta,
					pctChange,
					upstreams: curr.unique_upstreams || 0
				});
			}
			if (bursts.length === 0) {
				table.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-xs text-slate-500">No spikes detected.</td></tr>';
				return;
			}
			bursts.sort((a, b) => b.delta - a.delta || b.pctChange - a.pctChange);
			const top = bursts.slice(0, 5);
			table.innerHTML = top.map(row =>
				'<tr class="table-row">' +
				'<td class="px-6 py-3 text-sm text-slate-200">' + row.ts + '</td>' +
				'<td class="px-6 py-3 text-sm text-right text-cyan-300 font-semibold">+' + row.delta.toLocaleString() + '</td>' +
				'<td class="px-6 py-3 text-sm text-right text-slate-200">' + row.pctChange.toFixed(1) + '%</td>' +
				'<td class="px-6 py-3 text-sm text-right text-slate-400">' + row.upstreams + '</td>' +
				'</tr>'
			).join('');
		}
		function updateTopTalkersTable(d) { document.getElementById('topTalkersTable').innerHTML = d.map(i => '<tr class="table-row"><td class="px-6 py-4 whitespace-nowrap text-sm font-mono text-gray-200">' + i.ip + '</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400">' + (i.country || 'Unknown') + '</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-200 text-right font-semibold">' + formatBytes(i.total_bytes) + '</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400 text-right">' + i.connections + '</td></tr>').join('') }
		function updateProtocolTable(d) { document.getElementById('protocolTable').innerHTML = d.map(i => '<tr class="table-row"><td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-200">' + i.protocol + '</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-200 text-right">' + i.connections.toLocaleString() + '</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400 text-right">' + i.unique_ips + '</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-200 text-right">' + formatBytes(i.total_bytes) + '</td></tr>').join('') }
		function updateUpstreamTable(d) { document.getElementById('upstreamTable').innerHTML = d.map(i => '<tr class="table-row clickable" onclick="showServerDetails(\'' + i.upstream_addr.replace(/'/g, "\\'") + '\')"><td class="px-6 py-4 whitespace-nowrap text-sm font-mono text-gray-200">' + i.upstream_addr + '</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-200 text-right">' + i.connections.toLocaleString() + '</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400 text-right">' + i.unique_ips + '</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-200 text-right">' + formatBytes(i.total_bytes) + '</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400 text-right">' + i.avg_session_time_seconds.toFixed(2) + 's</td><td class="px-6 py-4 whitespace-nowrap text-sm ' + (i.failed_connections > 0 ? 'text-red-400' : 'text-gray-400') + ' text-right">' + i.failed_connections + '</td></tr>').join('') }

		async function showServerDetails(server) {
			const modal = document.getElementById('serverModal');
			const modalServerName = document.getElementById('modalServerName');
			const modalTotalIPs = document.getElementById('modalTotalIPs');
			const modalTotalConnections = document.getElementById('modalTotalConnections');
			const modalTotalTraffic = document.getElementById('modalTotalTraffic');
			const modalIPTable = document.getElementById('modalIPTable');

			// Show modal with loading state
			modalServerName.textContent = server;
			modalTotalIPs.textContent = '-';
			modalTotalConnections.textContent = '-';
			modalTotalTraffic.textContent = '-';
			modalIPTable.innerHTML = '<tr><td colspan="4" class="px-4 py-8 text-center text-gray-400">Loading...</td></tr>';
			modal.classList.add('active');

			try {
				// Fetch detailed IP data
				const response = await fetch('/streamInfo/data' + getDateParams());
				if (!response.ok) {
					throw new Error('Failed to load upstream data');
				}

				const payload = await response.json();
				const entries = Array.isArray(payload)
					? payload
					: (Array.isArray(payload.entries) ? payload.entries : []);

				// Filter entries for this specific server
				const serverEntries = entries.filter(entry => entry.upstream_addr === server);

				// Aggregate by IP
				const ipStats = {};
				serverEntries.forEach(entry => {
					if (!ipStats[entry.client_ip]) {
						ipStats[entry.client_ip] = {
							ip: entry.client_ip,
							country: entry.country || 'Unknown',
							connections: 0,
							totalBytes: 0
						};
					}
					ipStats[entry.client_ip].connections++;
					ipStats[entry.client_ip].totalBytes += entry.bytes_sent + entry.bytes_received;
				});

				// Convert to array and sort
				const ipArray = Object.values(ipStats).sort((a, b) => b.totalBytes - a.totalBytes);

				// Update summary
				const totalIPs = ipArray.length;
				const totalConnections = ipArray.reduce((sum, ip) => sum + ip.connections, 0);
				const totalTraffic = ipArray.reduce((sum, ip) => sum + ip.totalBytes, 0);

				modalTotalIPs.textContent = totalIPs.toLocaleString();
				modalTotalConnections.textContent = totalConnections.toLocaleString();
				modalTotalTraffic.textContent = formatBytes(totalTraffic);

				// Update table
				if (ipArray.length === 0) {
					modalIPTable.innerHTML = '<tr><td colspan="4" class="px-4 py-8 text-center text-gray-400">No data available</td></tr>';
				} else {
					modalIPTable.innerHTML = ipArray.map(ip =>
						'<tr class="table-row">' +
						'<td class="px-4 py-3 whitespace-nowrap text-sm font-mono text-gray-200">' + ip.ip + '</td>' +
						'<td class="px-4 py-3 whitespace-nowrap text-sm text-gray-400">' + ip.country + '</td>' +
						'<td class="px-4 py-3 whitespace-nowrap text-sm text-gray-200 text-right">' + ip.connections.toLocaleString() + '</td>' +
						'<td class="px-4 py-3 whitespace-nowrap text-sm text-gray-200 text-right">' + formatBytes(ip.totalBytes) + '</td>' +
						'</tr>'
					).join('');
				}
			} catch (error) {
				console.error('Error loading server details:', error);
				modalIPTable.innerHTML = '<tr><td colspan="4" class="px-4 py-8 text-center text-red-400">Error loading data</td></tr>';
			}
		}

		function closeServerModal() {
			document.getElementById('serverModal').classList.remove('active');
		}

		// Close modal when clicking outside
		window.onclick = function (event) {
			const modal = document.getElementById('serverModal');
			if (event.target === modal) {
				closeServerModal();
			}
		}
		function refreshData(options = {}) {
			if (isLoadingData) return;
			loadData({ silent: true, ...options });
		}
		async function initializeDateRange() { try { const dateInfo = await fetch('/streamInfo/daterange').then(r => r.json()); if (dateInfo.min_date && dateInfo.max_date) { document.getElementById('startDate').value = dateInfo.min_date; document.getElementById('endDate').value = dateInfo.max_date } } catch (e) { console.error('Error loading date range:', e) } }
		window.addEventListener('DOMContentLoaded', () => { clearCountryDetail(); initializeDateRange(); loadData() }); setInterval(refreshData, 20000);
	</script>
</body>

</html>